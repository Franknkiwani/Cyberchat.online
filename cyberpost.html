<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload Post</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #000000;
    }
    input, textarea, select {
      color: #fff;
      font-weight: 600;
      background-color: #151515 !important;
    }
    input:-webkit-autofill,
    textarea:-webkit-autofill,
    select:-webkit-autofill {
      box-shadow: 0 0 0px 1000px #151515 inset;
      -webkit-text-fill-color: #fff !important;
      font-weight: 600;
    }
    header {
      background-color: #0f0f0f;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    /* Modal styles */
    #loginModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(6px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #loginModal.hidden {
      display: none;
    }
    #loginModalContent {
      background: #111;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 0 10px #ff4444;
      max-width: 360px;
      width: 90%;
      text-align: center;
      color: white;
    }
    #loginModalContent button {
      background-color: #ff4444;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      margin-top: 1.5rem;
      transition: background-color 0.3s ease;
    }
    #loginModalContent button:hover {
      background-color: #cc3333;
    }
  </style>
</head>
<body class="text-white min-h-screen flex flex-col font-sans">

  <!-- Header -->
  <header class="sticky top-0 z-30 w-full px-6 py-4 bg-[#0f0f0f] border-b border-gray-800 flex items-center justify-between shadow">
    <div class="flex items-center space-x-4">
      <!-- Profile Picture and Info -->
      <img id="profilePic" src="https://via.placeholder.com/40" alt="Profile Pic" class="profile-pic" />
      <div class="text-white">
        <p id="userHandle" class="font-bold">@loading...</p>
        <p id="userFollowers" class="text-sm text-gray-400">Followers: --</p>
      </div>
    </div>
    <button id="postBtn"
      class="bg-red-600 hover:bg-red-700 active:bg-red-800 transition px-5 py-2 rounded text-sm font-medium shadow">
      Publish
    </button>
  </header>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto px-6 py-8 max-w-4xl w-full mx-auto space-y-10">

    <!-- Preview Image -->
    <section class="space-y-3">
      <h2 class="text-base font-semibold text-gray-300 text-center">Post Image</h2>
      <div class="w-full aspect-square max-w-md mx-auto rounded-lg overflow-hidden bg-gray-900 border border-gray-800 shadow">
        <img id="previewImage" src="https://via.placeholder.com/720x720.png?text=Post+Image+Preview"
          alt="Post Preview" class="w-full h-full object-cover" />
      </div>
    </section>

    <!-- Title -->
    <section class="space-y-1 max-w-xl mx-auto">
      <label for="titleInput" class="block text-sm text-gray-400 font-medium">Post Title</label>
      <input 
        id="titleInput" 
        type="text" 
        maxlength="100"
        placeholder="Enter post title here (e.g. My first cyber post)" 
        class="w-full border border-gray-700 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-500 transition"
        aria-describedby="titleHelp"
        autocomplete="off"
      />
      <p id="titleHelp" class="text-xs text-gray-500">Max 100 characters</p>
    </section>

    <!-- Description -->
    <section class="space-y-1 max-w-xl mx-auto">
      <label for="captionInput" class="block text-sm text-gray-400 font-medium">Description</label>
      <textarea 
        id="captionInput" 
        maxlength="500" 
        rows="5" 
        placeholder="Write a description... (e.g. A glimpse into the neon-lit streets)" 
        class="w-full border border-gray-700 rounded px-4 py-3 resize-none focus:outline-none focus:ring-2 focus:ring-red-500 transition"
        aria-describedby="descHelp"
        autocomplete="off"
      ></textarea>
      <p id="descHelp" class="text-xs text-gray-500">Max 500 characters</p>
    </section>

    <!-- Tags -->
    <section class="space-y-1 max-w-xl mx-auto">
      <label for="tagsInput" class="block text-sm text-gray-400 font-medium">Tags</label>
      <input 
        id="tagsInput" 
        type="text" 
        maxlength="100"
        placeholder="Add tags separated by commas (e.g. tech, photography, travel)" 
        class="w-full border border-gray-700 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-500 transition"
        aria-describedby="tagsHelp"
        autocomplete="off"
      />
      <p id="tagsHelp" class="text-xs text-gray-500">Separate tags with commas, max 100 characters</p>
    </section>

    <!-- Category -->
    <section class="space-y-1 max-w-xl mx-auto">
      <label for="categorySelect" class="block text-sm text-gray-400 font-medium">Category</label>
      <select 
        id="categorySelect"
        class="w-full border border-gray-700 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-500 transition"
      >
        <option value="" disabled selected>Select a category</option>
        <option value="Travel">Travel</option>
        <option value="Tech">Tech</option>
        <option value="Gaming">Gaming</option>
        <option value="Lifestyle">Lifestyle</option>
        <option value="Music">Music</option>
      </select>
    </section>
    
  </main>

  <!-- Login Modal -->
  <div id="loginModal">
    <div id="loginModalContent">
      <h2 class="text-xl font-bold mb-4">Please Log In</h2>
      <p class="mb-6">You must be logged in to upload posts.</p>
      <button id="loginBtn">Log In</button>
    </div>
  </div>
  <!-- Firebase and App Script -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
import { getDatabase, ref, get, child, push, set } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
  measurementId: "G-LLT6F9WRKH"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

const loginModal = document.getElementById('loginModal');
const loginBtn = document.getElementById('loginBtn');

const profilePic = document.getElementById('profilePic');
const userHandle = document.getElementById('userHandle');
const userFollowers = document.getElementById('userFollowers');

function showLogin() {
  loginModal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}
function hideLogin() {
  loginModal.classList.add('hidden');
  document.body.style.overflow = 'auto';
}

loginBtn.addEventListener('click', () => {
  signInWithPopup(auth, provider)
    .catch((error) => alert("Login failed: " + error.message));
});

onAuthStateChanged(auth, async (user) => {
  if (user) {
    hideLogin();
    const uid = user.uid;

    profilePic.src = user.photoURL || 'https://via.placeholder.com/40';
    userHandle.textContent = '@' + (user.displayName?.replace(/\s+/g, '').toLowerCase() || 'user');

    try {
      const dbRef = ref(database);
      const snapshot = await get(child(dbRef, `users/${uid}/followers`));
      if (snapshot.exists()) {
        userFollowers.textContent = `Followers: ${snapshot.val()}`;
      } else {
        userFollowers.textContent = 'Followers: 0';
      }
    } catch (error) {
      console.error("Failed to fetch followers:", error);
      userFollowers.textContent = 'Followers: --';
    }
  } else {
    showLogin();
    profilePic.src = 'https://via.placeholder.com/40';
    userHandle.textContent = '@guest';
    userFollowers.textContent = 'Followers: --';
  }
});

// ---- IMAGE UPLOAD + EDIT SETUP ----

const imageInput = document.createElement('input');
imageInput.type = 'file';
imageInput.accept = 'image/*';
imageInput.classList.add('hidden');
document.body.appendChild(imageInput);

const previewImage = document.getElementById('previewImage');
const editBtn = document.createElement('button');
editBtn.textContent = 'Edit Image';
editBtn.className = 'mt-2 px-4 py-1 bg-cyan-600 rounded text-white text-sm hover:bg-cyan-700';
previewImage.parentElement.appendChild(editBtn);

editBtn.style.display = 'none'; // hide until image uploaded

const modal = document.createElement('div');
modal.className = 'fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-50 hidden';
modal.innerHTML = `
  <div class="bg-gray-900 p-4 rounded max-w-3xl w-full relative">
    <div style="max-height: 70vh; overflow: auto;">
      <img id="cropperImage" style="max-width:100%; display:block; margin:auto;"/>
      <canvas id="fabricCanvas" style="display:none; border:1px solid #444;"></canvas>
    </div>
    <div class="mt-4 flex space-x-4 justify-end">
      <button id="addTextBtn" class="px-4 py-2 bg-cyan-600 rounded text-white hover:bg-cyan-700">Add Text</button>
      <button id="saveEditBtn" class="px-4 py-2 bg-green-600 rounded text-white hover:bg-green-700">Save</button>
      <button id="cancelEditBtn" class="px-4 py-2 bg-red-600 rounded text-white hover:bg-red-700">Cancel</button>
    </div>
  </div>
`;
document.body.appendChild(modal);

const cropperImage = modal.querySelector('#cropperImage');
const fabricCanvasEl = modal.querySelector('#fabricCanvas');
const addTextBtn = modal.querySelector('#addTextBtn');
const saveEditBtn = modal.querySelector('#saveEditBtn');
const cancelEditBtn = modal.querySelector('#cancelEditBtn');

let cropper = null;
let fabricCanvas = null;
let currentImageFile = null;
let croppedDataUrl = null;

previewImage.parentElement.addEventListener('click', () => {
  imageInput.click();
});

imageInput.addEventListener('change', () => {
  const file = imageInput.files[0];
  if (!file) return;

  currentImageFile = file;
  const reader = new FileReader();
  reader.onload = (e) => {
    previewImage.src = e.target.result;
    previewImage.style.objectFit = 'cover';

    editBtn.style.display = 'inline-block';
    croppedDataUrl = null;
  };
  reader.readAsDataURL(file);
});

editBtn.addEventListener('click', () => {
  if (!previewImage.src) return;

  modal.classList.remove('hidden');
  cropperImage.style.display = 'block';
  fabricCanvasEl.style.display = 'none';

  cropperImage.src = previewImage.src;

  cropperImage.onload = () => {
    if (cropper) cropper.destroy();
    cropper = new Cropper(cropperImage, {
      aspectRatio: 16 / 9,
      viewMode: 1,
      autoCropArea: 1,
      movable: true,
      zoomable: true,
      scalable: false,
      cropBoxResizable: true,
      background: false,
    });

    if (!fabricCanvas) {
      fabricCanvas = new fabric.Canvas(fabricCanvasEl, {
        width: cropperImage.naturalWidth,
        height: cropperImage.naturalHeight,
        backgroundColor: 'transparent',
      });
    }
  };
});

addTextBtn.addEventListener('click', () => {
  if (!fabricCanvas) return;

  if (cropper) {
    const croppedCanvas = cropper.getCroppedCanvas();
    const dataURL = croppedCanvas.toDataURL();

    cropperImage.style.display = 'none';
    fabricCanvasEl.style.display = 'block';

    fabricCanvas.setWidth(croppedCanvas.width);
    fabricCanvas.setHeight(croppedCanvas.height);

    fabric.Image.fromURL(dataURL, (img) => {
      fabricCanvas.clear();
      fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas));
    });
  }

  const text = new fabric.Textbox('Enter text', {
    left: 20,
    top: 20,
    fill: '#ffffff',
    fontSize: 30,
    fontWeight: 'bold',
    editable: true,
    backgroundColor: 'rgba(0,0,0,0.3)',
    padding: 5,
  });
  fabricCanvas.add(text);
  fabricCanvas.setActiveObject(text);
  fabricCanvas.renderAll();
});

cancelEditBtn.addEventListener('click', () => {
  modal.classList.add('hidden');
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
  if (fabricCanvas) {
    fabricCanvas.clear();
  }
});

saveEditBtn.addEventListener('click', () => {
  if (fabricCanvasEl.style.display === 'block' && fabricCanvas) {
    croppedDataUrl = fabricCanvas.toDataURL({
      format: 'png',
      quality: 1,
    });
  } else if (cropper) {
    croppedDataUrl = cropper.getCroppedCanvas().toDataURL('image/png');
  } else {
    alert('No image to save.');
    return;
  }

  previewImage.src = croppedDataUrl;
  previewImage.style.objectFit = 'cover';
  modal.classList.add('hidden');

  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
  if (fabricCanvas) {
    fabricCanvas.clear();
  }
});

const postBtn = document.getElementById('postBtn');

postBtn.addEventListener('click', async () => {
  const titleInput = document.getElementById('titleInput');
  const captionInput = document.getElementById('captionInput');
  const tagsInput = document.getElementById('tagsInput');
  const categorySelect = document.getElementById('categorySelect');

  if (!titleInput.value.trim()) return alert('Title is required');
  if (!captionInput.value.trim()) return alert('Caption is required');
  if (!tagsInput.value.trim()) return alert('Tags are required');
  if (!categorySelect.value) return alert('Please select a category');
  if (!previewImage.src || previewImage.src.includes('placeholder')) 
    return alert('Please upload and edit an image before posting.');

  const user = auth.currentUser;
  if (!user) {
    alert('You must be logged in to post.');
    return;
  }

  try {
    // Upload image to Firebase Storage
    const storageRef = sRef(storage, `posts/${user.uid}/${Date.now()}.png`);
    const imageData = croppedDataUrl || previewImage.src;

    // Upload the base64 image string
    await uploadString(storageRef, imageData, 'data_url');

    // Get the download URL
    const imageUrl = await getDownloadURL(storageRef);

    // Prepare post data
    const postData = {
      userId: user.uid,
      userName: user.displayName || user.email || 'Anonymous',
      userPhoto: user.photoURL || '',
      title: titleInput.value.trim(),
      caption: captionInput.value.trim(),
      tags: tagsInput.value.trim().split(',').map(t => t.trim()).filter(t => t),
      category: categorySelect.value,
      imageUrl,
      createdAt: Date.now()
    };

    // Push post to Realtime Database
    const postsRef = ref(database, 'posts');
    const newPostRef = push(postsRef);
    await set(newPostRef, postData);

    alert('Post published successfully!');
    // Optionally clear inputs or redirect
    titleInput.value = '';
    captionInput.value = '';
    tagsInput.value = '';
    categorySelect.value = '';
    previewImage.src = 'https://via.placeholder.com/1280x720.png?text=Preview+Image';
    editBtn.style.display = 'none';
    croppedDataUrl = null;

  } catch (error) {
    console.error('Error posting:', error);
    alert('Failed to publish post: ' + error.message);
  }
});

  document.addEventListener('DOMContentLoaded', () => {
    const imageData = sessionStorage.getItem('uploadedImage');
    const previewImage = document.getElementById('previewImage');

    if (imageData && previewImage) {
      previewImage.src = imageData;
    } else {
      alert("No image found, redirecting...");
      window.history.back();
    }
  });
</script>
</body>
</html>