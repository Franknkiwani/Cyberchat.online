<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Revenue & Profile</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      background-color: #0d0d0d;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      color: #eee;
      min-height: 100vh;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0 40px;
      gap: 8px;
    }

    .header {
      width: 90%;
      max-width: 900px;
      height: 70px;
      background: linear-gradient(145deg, #1c1c1c, #0a0a0a);
      border-radius: 25px;
      box-shadow:
        inset 0 0 10px #111,
        0 8px 15px rgba(0, 0, 0, 0.6),
        0 0 0 4px #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      position: sticky;
      top: 20px;
      z-index: 999;
      margin-bottom: 20px;
    }

    .header .title {
      color: white;
      font-weight: 700;
      font-size: 1.3rem;
      letter-spacing: 1.5px;
      user-select: none;
      text-transform: uppercase;
    }

    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      padding: 4px;
      border: 2px solid #ff2d95;
      box-shadow: 0 0 8px #ff2d95, 0 0 15px #b30066;
      overflow: hidden;
      flex-shrink: 0;
    }

    .profile-pic img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .revenue-button {
      width: 140px;
      background: linear-gradient(145deg, #2b2b2b, #161616);
      border-radius: 20px;
      box-shadow: inset 0 2px 5px #444, 0 0 10px 3px rgba(144, 238, 144, 0.7);
      color: #90ee90;
      font-weight: 600;
      font-size: 1rem;
      text-align: center;
      padding: 8px 0;
      user-select: none;
      cursor: default;
      margin-left: 5%;
    }

    .monetize-status {
      width: 140px;
      font-weight: 700;
      font-size: 0.85rem;
      text-align: right;
      color: #90ee90;
      user-select: none;
      margin-right: 5%;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .progress-container {
      width: 90%;
      max-width: 900px;
      margin-top: 30px;
    }

    .progress-block {
      margin-bottom: 20px;
    }

    .progress-title {
      font-size: 0.9rem;
      margin-bottom: 5px;
      color: #ccc;
    }

    .progress-bar {
      height: 15px;
      border-radius: 8px;
      background-color: #333;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: #90ee90;
      transition: width 0.4s ease;
    }

    .monetize-button {
      width: 90%;
      max-width: 900px;
      padding: 15px;
      margin-top: 20px;
      font-size: 1.2rem;
      font-weight: 700;
      text-align: center;
      border-radius: 15px;
      cursor: not-allowed;
      background-color: #555;
      color: #aaa;
      border: none;
      pointer-events: none;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .monetize-button.active {
      background-color: #00cc66;
      color: #fff;
      cursor: pointer;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">CYBERCHAT</div>
    <div class="profile-pic">
      <img id="profileImg" src="https://i.imgur.com/4ZQZK4z.png" alt="Profile Picture" />
    </div>
  </div>

  <div style="width:90%; max-width:900px; display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px;">
    <button class="revenue-button">Revenue $0.000</button>
    <div id="monetizeStatus" class="monetize-status">...</div>
  </div>

  <div class="progress-container">
    <div class="progress-block">
      <div class="progress-title">Public Posts (10 required)</div>
      <div class="progress-bar">
        <div id="postProgress" class="progress-fill" style="width: 0%"></div>
      </div>
    </div>

    <div class="progress-block">
      <div class="progress-title">Following Users (100 required)</div>
      <div class="progress-bar">
        <div id="followProgress" class="progress-fill" style="width: 0%"></div>
      </div>
    </div>

    <button id="monetizeNowBtn" class="monetize-button">Monetize Now</button>
  </div>

  <!-- Graph for Revenue Analytics -->
  <div id="graphContainer" style="display:none;">
    <canvas id="revenueChart"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const app = initializeApp(firebaseConfig);
  getAnalytics(app);
  const auth = getAuth();
  const db = getDatabase();

  const profileImg = document.getElementById('profileImg');
  const revenueBtn = document.querySelector('.revenue-button');
  const monetizeStatus = document.getElementById('monetizeStatus');
  const postProgress = document.getElementById('postProgress');
  const followProgress = document.getElementById('followProgress');
  const monetizeNowBtn = document.getElementById('monetizeNowBtn');
  const progressContainer = document.querySelector('.progress-container');
  const graphContainer = document.getElementById('graphContainer');

  const fallbackUrl = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT-0NfFQ2gA6VYmRoeTPvEIL4fFtf-fI0ZMQXRkFs4zV91Tu_p9-t5uXZmY&s=10";

  let cachedPosts = 0, cachedFollows = 0;
  let monetizeStatusValue = null;
  let chartInstance = null;

  onAuthStateChanged(auth, (user) => {
    if (!user) return;
    const uid = user.uid;

    // Profile pic with fallback
    onValue(ref(db, `users/${uid}/profilePic`), (snap) => {
      profileImg.src = snap.val() || fallbackUrl;
    });
    profileImg.onerror = () => profileImg.src = fallbackUrl;

    // Revenue button update
    onValue(ref(db, `users/${uid}/revenue`), (snap) => {
      const rev = snap.val();
      const revNum = Number(rev);
      revenueBtn.textContent = `Revenue $${isNaN(revNum) ? '0.000' : revNum.toFixed(3)}`;
    });

    // Monetize status handling (on, off, banned)
    onValue(ref(db, `users/${uid}/monetize`), (snap) => {
      monetizeStatusValue = snap.val();

      if (monetizeStatusValue === 'on') {
        monetizeStatus.textContent = "YOU MONETIZED";
        monetizeStatus.style.color = "#90ee90";

        monetizeNowBtn.style.display = 'none';
        progressContainer.style.display = 'none';
        graphContainer.style.display = 'block';

        setupLiveGraph(uid);

      } else if (monetizeStatusValue === 'banned') {
        monetizeStatus.textContent = "YOU ARE BANNED";
        monetizeStatus.style.color = "#ff4c4c";

        monetizeNowBtn.textContent = "BANNED";
        monetizeNowBtn.classList.remove('active');
        monetizeNowBtn.onclick = null;
        monetizeNowBtn.style.display = 'inline-block';
        monetizeNowBtn.style.color = '#ff4c4c';

        progressContainer.style.display = 'block';
        graphContainer.style.display = 'none';

      } else {
        monetizeStatus.textContent = "NOT MONETIZED";
        monetizeStatus.style.color = "#ff4c4c";

        monetizeNowBtn.textContent = "Monetize Now";
        monetizeNowBtn.style.color = '';
        monetizeNowBtn.style.display = 'inline-block';

        progressContainer.style.display = 'block';
        graphContainer.style.display = 'none';

        checkMonetizeEligibility(cachedPosts, cachedFollows);
      }
    });

    // Posts count and progress bar
    onValue(ref(db, `post`), (snap) => {
      let publicPosts = 0;
      snap.forEach(child => {
        const data = child.val();
        if (data.userId === uid && data.visibility === "public") publicPosts++;
      });
      cachedPosts = publicPosts;
      if (monetizeStatusValue !== 'on' && monetizeStatusValue !== 'banned') {
        const percent = Math.min((publicPosts / 10) * 100, 100);
        postProgress.style.width = percent + '%';
      }
      checkMonetizeEligibility(publicPosts, null);
    });

    // Following count and progress bar
    onValue(ref(db, `users/${uid}/following`), (snap) => {
      const count = snap.exists() ? Object.keys(snap.val()).length : 0;
      cachedFollows = count;
      if (monetizeStatusValue !== 'on' && monetizeStatusValue !== 'banned') {
        const percent = Math.min((count / 100) * 100, 100);
        followProgress.style.width = percent + '%';
      }
      checkMonetizeEligibility(null, count);
    });
  });

  function checkMonetizeEligibility(posts, follows) {
    if (posts !== null) cachedPosts = posts;
    if (follows !== null) cachedFollows = follows;

    if (cachedPosts >= 10 && cachedFollows >= 100 && monetizeStatusValue !== 'on' && monetizeStatusValue !== 'banned') {
      monetizeNowBtn.classList.add('active');
      monetizeNowBtn.onclick = () => location.href = 'monitizenow.html';
    } else {
      monetizeNowBtn.classList.remove('active');
      monetizeNowBtn.onclick = null;
    }
  }

  function setupLiveGraph(uid) {
    const ctx = document.getElementById('revenueChart').getContext('2d');

    if (chartInstance) {
      chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [], // post titles or IDs
        datasets: [
          {
            label: 'Views',
            data: [],
            borderColor: 'blue',
            fill: false,
          },
          {
            label: 'Revenue ($)',
            data: [],
            borderColor: 'green',
            fill: false,
          }
        ],
      },
      options: {
        animation: false,
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    const statsRef = ref(db, `post`);
    onValue(statsRef, (snap) => {
      const labels = [];
      const viewsData = [];
      const revenueData = [];

      snap.forEach(child => {
        const post = child.val();
        if (post.userId === uid) {
          labels.push(post.title || child.key);
          viewsData.push(post.views || 0);
          revenueData.push(post.revenue || 0);
        }
      });

      chartInstance.data.labels = labels;
      chartInstance.data.datasets[0].data = viewsData;
      chartInstance.data.datasets[1].data = revenueData;
      chartInstance.update();
    });
  }
</script>
</body>
</html>