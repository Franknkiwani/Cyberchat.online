<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live User Stats - Dark Gamer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body, html {
    height: 100%;
    background: #0a0a0f;
    color: #0ff; /* Neon cyan */
    font-family: 'Orbitron', monospace;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    user-select: none;
  }
  header {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 20px;
    text-shadow: 0 0 15px #0ff, 0 0 30px #00f;
    letter-spacing: 0.1em;
  }
  #chartContainer {
    width: 90vw;
    max-width: 900px;
    height: 450px;
    background: rgba(10,10,15,0.8);
    border-radius: 15px;
    box-shadow: 0 0 25px #00ffff55;
    padding: 20px;
    backdrop-filter: blur(8px);
  }
  canvas {
    width: 100% !important;
    height: 100% !important;
  }
  footer {
    margin-top: 30px;
    font-size: 0.9rem;
    color: #00f6ffaa;
  }
  #loginMessage {
    margin-bottom: 15px;
    font-size: 1.2rem;
    color: #0ff7;
  }
  button {
    background: #00ffff33;
    border: 1.5px solid #0ff;
    color: #0ff;
    padding: 8px 20px;
    border-radius: 6px;
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:hover {
    background: #00ffff88;
  }
</style>
</head>
<body>

<header>CyberGame User Stats</header>
<div id="loginMessage">Checking login status...</div>
<button id="loginBtn" style="display:none;">Login with Google</button>
<div id="chartContainer" style="display:none;">
  <canvas id="liveChart"></canvas>
</div>
<footer>Powered by Firebase &amp; Chart.js</footer>

<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Firebase config - replace with your project config!
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const loginMessage = document.getElementById('loginMessage');
  const loginBtn = document.getElementById('loginBtn');
  const chartContainer = document.getElementById('chartContainer');

  // Chart.js setup
  const ctx = document.getElementById('liveChart').getContext('2d');
  const liveChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [], // timestamps
      datasets: [
        {
          label: 'Views',
          borderColor: '#00ffff',
          backgroundColor: 'rgba(0,255,255,0.15)',
          fill: true,
          tension: 0.3,
          data: [],
          pointRadius: 3,
          pointHoverRadius: 6,
          borderWidth: 2,
        },
        {
          label: 'Followers',
          borderColor: '#ff00ff',
          backgroundColor: 'rgba(255,0,255,0.15)',
          fill: true,
          tension: 0.3,
          data: [],
          pointRadius: 3,
          pointHoverRadius: 6,
          borderWidth: 2,
        }
      ]
    },
    options: {
      animation: { duration: 500 },
      responsive: true,
      scales: {
        x: {
          type: 'time',
          time: { unit: 'minute', tooltipFormat: 'HH:mm:ss' },
          grid: { color: '#004444' },
          ticks: { color: '#0ff' }
        },
        y: {
          beginAtZero: true,
          grid: { color: '#004444' },
          ticks: { color: '#0ff' }
        }
      },
      plugins: {
        legend: {
          labels: { color: '#0ff', font: { weight: 'bold' } }
        },
        tooltip: {
          mode: 'nearest',
          intersect: false,
          backgroundColor: '#002222',
          titleColor: '#0ff',
          bodyColor: '#0ff'
        }
      }
    }
  });

  // Helper to update chart with data points (merged and sorted timestamps)
  function updateChartData(viewsData, followersData) {
    // Combine timestamps
    const timestampsSet = new Set([
      ...Object.keys(viewsData),
      ...Object.keys(followersData)
    ]);
    const timestamps = Array.from(timestampsSet).sort((a,b) => a - b).slice(-30);

    liveChart.data.labels = timestamps.map(ts => new Date(Number(ts)));

    liveChart.data.datasets[0].data = timestamps.map(ts => viewsData[ts] ?? null);
    liveChart.data.datasets[1].data = timestamps.map(ts => followersData[ts] ?? null);

    liveChart.update();
  }

  // Listen to auth state
  auth.onAuthStateChanged(user => {
    if (user) {
      loginMessage.style.display = 'none';
      loginBtn.style.display = 'none';
      chartContainer.style.display = 'block';

      const uid = user.uid;
      const viewsRef = db.ref(`/users/${uid}/stats/views`);
      const followersRef = db.ref(`/users/${uid}/stats/followers`);

      // Store latest snapshots
      let latestViews = {};
      let latestFollowers = {};

      viewsRef.on('value', snapshot => {
        latestViews = snapshot.val() || {};
        updateChartData(latestViews, latestFollowers);
      });

      followersRef.on('value', snapshot => {
        latestFollowers = snapshot.val() || {};
        updateChartData(latestViews, latestFollowers);
      });

    } else {
      // Not logged in, show login button
      loginMessage.textContent = 'You must login to see your live stats.';
      loginMessage.style.display = 'block';
      loginBtn.style.display = 'inline-block';
      chartContainer.style.display = 'none';
    }
  });

  // Login with Google
  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(console.error);
  };
</script>

</body>
</html>