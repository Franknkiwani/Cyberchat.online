<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Revenue & Profile</title>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0;
      background-color: #0d0d0d;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      color: #eee;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0 40px;
      gap: 8px;
    }
    .header {
      width: 90%;
      max-width: 900px;
      height: 70px;
      background: linear-gradient(145deg, #1c1c1c, #0a0a0a);
      border-radius: 25px;
      box-shadow:
        inset 0 0 10px #111,
        0 8px 15px rgba(0, 0, 0, 0.6),
        0 0 0 4px #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      position: sticky;
      top: 20px;
      z-index: 999;
      margin-bottom: 20px;
    }
    .header .title {
      color: white; /* changed to white */
      font-weight: 700;
      font-size: 1.3rem;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      letter-spacing: 1.5px;
      user-select: none;
      text-transform: uppercase;
    }
    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      padding: 4px;
      background-clip: content-box;
      border: 2px solid #ff2d95;
      box-shadow:
        0 0 8px #ff2d95,
        0 0 15px #b30066;
      box-sizing: content-box;
      overflow: hidden;
      flex-shrink: 0;
    }
    .profile-pic img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      display: block;
    }

    /* Progress bars container */
    .progress-container {
      width: 90%;
      max-width: 900px;
      background: #111;
      padding: 15px 20px;
      border-radius: 20px;
      box-shadow: 0 0 10px #222 inset;
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }
    .progress-label {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 6px;
      user-select: none;
    }
    progress {
      width: 100%;
      height: 18px;
      -webkit-appearance: none;
      appearance: none;
      border-radius: 10px;
      overflow: hidden;
    }
    progress::-webkit-progress-bar {
      background-color: #222;
    }
    progress::-webkit-progress-value {
      background: linear-gradient(90deg, #ff2d95, #b30066);
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    progress::-moz-progress-bar {
      background: linear-gradient(90deg, #ff2d95, #b30066);
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    /* Monetize Now button container */
    .monetize-container {
      width: 90%;
      max-width: 900px;
      display: flex;
      justify-content: center; /* center horizontally */
      margin-bottom: 30px;
    }
    .monetize-btn {
      padding: 12px 40px;
      font-size: 1.1rem;
      font-weight: 700;
      border-radius: 30px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease, color 0.3s ease;
      box-shadow:
        0 0 10px #ff2d95;
      background-color: grey;
      color: #ccc;
      pointer-events: none; /* disabled by default */
    }
    .monetize-btn.enabled {
      background-color: #3cd458;
      color: #0d0d0d;
      box-shadow:
        0 0 15px #3cd458;
      pointer-events: auto;
    }
    .monetize-btn.banned {
      background-color: #e63946;
      color: white;
      box-shadow: 0 0 15px #e63946;
      pointer-events: none;
      cursor: not-allowed;
    }

    /* Graph container */
    #graph-container {
      width: 90%;
      max-width: 900px;
      background: #111;
      padding: 20px;
      border-radius: 25px;
      box-shadow: 0 0 20px #b30066 inset;
      display: none; /* hidden by default */
      color: white;
    }

  </style>
</head>
<body>
  <div class="header">
    <div class="title">CYBERCHAT</div>
    <div class="profile-pic">
      <img id="profileImg" src="https://i.imgur.com/4ZQZK4z.png" alt="Profile Picture" />
    </div>
  </div>

  <!-- Progress Bars + Monetize Button -->
  <div id="progressSection">
    <div class="progress-container">
      <div class="progress-label">Public Posts (10 required)</div>
      <progress id="postsProgress" max="10" value="0"></progress>
    </div>
    <div class="progress-container">
      <div class="progress-label">Following Users (100 required)</div>
      <progress id="followingProgress" max="100" value="0"></progress>
    </div>
    <div class="monetize-container">
      <button id="monetizeBtn" class="monetize-btn" disabled>Monetize Now</button>
    </div>
  </div>

  <!-- Graph container for monetized users -->
  <div id="graph-container">
    <canvas id="monetizeGraph"></canvas>
  </div>

  <!-- Firebase & Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const profileImg = document.getElementById('profileImg');
    const monetizeBtn = document.getElementById('monetizeBtn');
    const postsProgress = document.getElementById('postsProgress');
    const followingProgress = document.getElementById('followingProgress');
    const progressSection = document.getElementById('progressSection');
    const graphContainer = document.getElementById('graph-container');
const ctx = document.getElementById('monetizeGraph').getContext('2d');

let monetizeGraph;

function createOrUpdateGraph(data) {
  const labels = data.map(item => item.date);
  const viewsData = data.map(item => item.views);
  const revenueData = data.map(item => item.revenue);

  if (!monetizeGraph) {
    monetizeGraph = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Views',
            data: viewsData,
            borderColor: '#3cd458',
            backgroundColor: 'rgba(60, 212, 88, 0.3)',
            yAxisID: 'y',
            tension: 0.3,
          },
          {
            label: 'Revenue ($)',
            data: revenueData,
            borderColor: '#ff2d95',
            backgroundColor: 'rgba(255, 45, 149, 0.3)',
            yAxisID: 'y1',
            tension: 0.3,
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        stacked: false,
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            ticks: {
              color: '#3cd458',
            },
            beginAtZero: true,
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
              drawOnChartArea: false,
            },
            ticks: {
              color: '#ff2d95',
            },
            beginAtZero: true,
          },
          x: {
            ticks: {
              color: '#eee',
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: '#eee'
            }
          }
        }
      }
    });
  } else {
    monetizeGraph.data.labels = labels;
    monetizeGraph.data.datasets[0].data = viewsData;
    monetizeGraph.data.datasets[1].data = revenueData;
    monetizeGraph.update();
  }
}

function updateProgressBars(posts, following) {
  postsProgress.value = posts;
  followingProgress.value = following;

  const canMonetize = posts >= 10 && following >= 100;

  monetizeBtn.disabled = !canMonetize;
  monetizeBtn.classList.toggle('enabled', canMonetize);
}

// Fetch user profile pic or fallback
function loadProfilePic(uid) {
  const userRef = ref(db, `users/${uid}/profilePicture`);
  onValue(userRef, (snapshot) => {
    const url = snapshot.val();
    profileImg.src = url || 'https://i.imgur.com/4ZQZK4z.png';
  });
}

// Load user stats and monetization state
onAuthStateChanged(auth, (user) => {
  if (!user) {
    // not logged in
    monetizeBtn.disabled = true;
    monetizeBtn.textContent = "Sign in to monetize";
    return;
  }

  loadProfilePic(user.uid);

  const monetizeStatusRef = ref(db, `users/${user.uid}/monetize`);
  const postsCountRef = ref(db, `userStats/${user.uid}/postsCount`);
  const followingCountRef = ref(db, `userStats/${user.uid}/followingCount`);
  const viewsRef = ref(db, `userStats/${user.uid}/dailyViews`);
  const revenueRef = ref(db, `userStats/${user.uid}/dailyRevenue`);

  // Show progress + button by default
  progressSection.style.display = 'block';
  graphContainer.style.display = 'none';

  onValue(monetizeStatusRef, (snapshot) => {
    const status = snapshot.val();

    if (status === 'on') {
      // Monetized user → hide progress + btn, show graph
      progressSection.style.display = 'none';
      graphContainer.style.display = 'block';

      // Listen for live views + revenue updates to update the graph
      // Assuming dailyViews and dailyRevenue are objects with date keys, e.g.,
      // { "2025-05-20": 120, "2025-05-21": 140, ... }
      let dailyViews = {};
      let dailyRevenue = {};

      onValue(viewsRef, (snap) => {
        dailyViews = snap.val() || {};
        updateGraphFromStats(dailyViews, dailyRevenue);
      });

      onValue(revenueRef, (snap) => {
        dailyRevenue = snap.val() || {};
        updateGraphFromStats(dailyViews, dailyRevenue);
      });

      function updateGraphFromStats(views, revenue) {
        // Combine views and revenue data by dates sorted ascending
        const dates = Object.keys({...views, ...revenue}).sort();
        const combinedData = dates.map(date => ({
          date,
          views: views[date] || 0,
          revenue: revenue[date] || 0,
        }));
        createOrUpdateGraph(combinedData);
      }

    } else if (status === 'banned') {
      // Banned user → show progress + banned button red
      progressSection.style.display = 'block';
      graphContainer.style.display = 'none';

      monetizeBtn.disabled = true;
      monetizeBtn.classList.remove('enabled');
      monetizeBtn.classList.add('banned');
      monetizeBtn.textContent = "Banned";

    } else {
      // Not monetized user → show progress + enabled button if requirements met
      progressSection.style.display = 'block';
      graphContainer.style.display = 'none';

      monetizeBtn.classList.remove('banned');
      monetizeBtn.textContent = "Monetize Now";

      // Fetch stats for progress bars
      onValue(postsCountRef, (snap) => {
        const postsCount = snap.val() || 0;
        onValue(followingCountRef, (snap2) => {
          const followingCount = snap2.val() || 0;
          updateProgressBars(postsCount, followingCount);
        });
      });
    }
  });

  // Monetize button click handler (example)
  monetizeBtn.onclick = () => {
    if (monetizeBtn.disabled) return;
    // Implement your monetize request logic here (e.g., update Firebase)
    alert("Monetize request sent! Admin will review your application.");
  };
});
  </script>
</body>
</html>