<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cyberchat - Social</title>
  <style>
    :root {
      --purple: #8a2be2;
      --light-green: #6eff92;
      --red: #ff4444;
      --white: #fff;
      --black: #000;
      --gray-dark: #222;
      --gray-medium: #444;
      --gray-light: #666;
      --input-bg: #1c1c1c;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none;
    }
    html, body {
      width: 100%;
      height: 100%;
      background-color: var(--black);
      color: var(--white);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 999;
      background-color: #111;
      padding: 0.75rem 1rem;
      font-size: 1.25rem;
      font-weight: 600;
      border-bottom: 1px solid var(--gray-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      display: flex;
      align-items: center;
      user-select: text; /* allow copy */
    }
    .cyber {
      background: linear-gradient(90deg, #ff00ff, #00ffff);
      background-size: 200% auto;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: textShift 5s ease-in-out infinite;
    }
    .chat {
      margin-left: 0.35rem;
      background: linear-gradient(90deg, #00ffff, #7f00ff, #00ffff);
      background-size: 200% auto;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: textShift 5s ease-in-out infinite;
    }
    @keyframes textShift {
      0% { background-position: 0% center; }
      50% { background-position: 100% center; }
      100% { background-position: 0% center; }
    }
    .post-btn {
      background-color: var(--light-green);
      color: #000;
      border: none;
      padding: 0.45rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease;
      outline: none;
      user-select: none;
    }
    .post-btn:hover {
      background-color: #52e074;
      box-shadow: 0 0 6px rgba(110, 255, 146, 0.4);
    }
    .post-btn:focus {
      outline: none;
    }
    main#main-content {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
      background-color: #121212;
      color: #ddd;
      font-size: 1rem;
      -webkit-overflow-scrolling: touch;
      user-select: text;
    }
    .post {
      background-color: #1c1c1c;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.05);
    }
    .post-title {
      font-weight: 700;
      font-size: 1.15rem;
      margin-bottom: 0.35rem;
      color: #fff;
    }
    .post-body {
      font-weight: 400;
      line-height: 1.4;
      color: #bbb;
    }
    /* Footer menu styles */
    footer#bottom-menu {
      position: sticky;
      bottom: 0;
      width: 100%;
      background-color: #111;
      border-top: 1px solid var(--gray-dark);
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 56px;
      user-select: none;
      z-index: 1000;
    }
    footer#bottom-menu button {
      background: none;
      border: none;
      color: #ccc;
      font-size: 0.7rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 0 0.4rem;
      transition: color 0.2s ease;
      outline: none;
      flex-grow: 1;
      max-width: 80px;
    }
    footer#bottom-menu button:hover,
    footer#bottom-menu button:focus {
      color: var(--light-green);
      outline: none;
    }
    footer#bottom-menu svg {
      width: 24px;
      height: 24px;
      margin-bottom: 2px;
      transition: fill 0.3s ease;
      fill: none;
      stroke-width: 2;
      stroke-linejoin: round;
      stroke-linecap: round;
      stroke: currentColor;
    }
    /* Icon colors always visible */
    footer#bottom-menu button.home svg {
      stroke: var(--white);
      fill: var(--white);
    }
    footer#bottom-menu button.community svg {
      stroke: var(--purple);
      fill: var(--purple);
    }
    footer#bottom-menu button.following svg {
      stroke: var(--light-green);
      fill: var(--light-green);
    }
    footer#bottom-menu button.profile svg {
      stroke: var(--red);
      fill: var(--red);
    }
    /* Active states white */
    footer#bottom-menu button.active svg {
      stroke: var(--white);
      fill: var(--white);
    }
    footer#bottom-menu button.active {
      color: var(--white);
    }
    /* Non-active text color same as icon */
    footer#bottom-menu button.home:not(.active),
    footer#bottom-menu button.community:not(.active),
    footer#bottom-menu button.following:not(.active),
    footer#bottom-menu button.profile:not(.active) {
      color: inherit;
    }

    /* === Profile section styles === */
    .profile-container {
      max-width: 400px;
      margin: 0 auto;
      text-align: center;
      padding: 1rem 0;
      user-select: none;
    }
    .profile-pic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 1rem;
      border: 3px solid var(--light-green);
      background-color: var(--gray-dark);
      user-select: none;
    }
    .editable-field {
      margin: 0.25rem 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--white);
      cursor: pointer;
      border-bottom: 1.5px dashed transparent;
      transition: border-color 0.2s ease;
      display: inline-block;
      min-width: 160px;
    }
    .editable-field:hover {
      border-color: var(--light-green);
    }
    .editable-field[contenteditable="true"] {
      border-color: var(--light-green);
      background-color: var(--input-bg);
      outline: none;
      cursor: text;
      padding: 2px 6px;
      border-radius: 5px;
      user-select: text;
    }
    .handle {
      color: var(--gray-light);
      font-weight: 400;
      margin-bottom: 1rem;
    }
    .followers-count {
      font-weight: 500;
      margin-bottom: 1.5rem;
    }
    /* Progress bars container */
    .progress-bars {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
    }
    .progress-bar {
      flex: 1;
      background: var(--gray-medium);
      border-radius: 10px;
      overflow: hidden;
      height: 18px;
      user-select: none;
    }
    .progress-fill {
      height: 100%;
      background: var(--light-green);
      border-radius: 10px 0 0 10px;
      transition: width 0.3s ease;
    }
    .progress-label {
      text-align: center;
      margin-top: 0.3rem;
      font-size: 0.8rem;
      color: var(--gray-light);
      user-select: text;
    }
    /* Email and other profile info */
    .profile-info {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: var(--gray-light);
      user-select: text;
      max-width: 280px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.4;
    }
    /* Input fields for edits - hidden by default */
    input.edit-input {
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      background-color: var(--input-bg);
      border: none;
      color: var(--white);
      border-radius: 5px;
      padding: 4px 8px;
      outline: none;
      width: 180px;
      user-select: text;
    }
    /* Hide inputs by default */
    input.edit-input.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <span class="cyber">CYBER</span><span class="chat">CHAT</span>
    </div>
    <button class="post-btn">My Post</button>
  </header>

  <main id="main-content">
    <!-- Dynamic content loaded here -->
  </main>

  <footer id="bottom-menu">
    <button class="home active" aria-label="Home" title="Home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M3 12L12 3l9 9v9a3 3 0 0 1-3 3h-12a3 3 0 0 1-3-3z"/>
        <path d="M9 21v-6h6v6"/>
      </svg>
      Home
    </button>
    <button class="community" aria-label="Community" title="Community">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="10" />
        <path d="M8 14s1.5 2 4 0" />
      </svg>
      Community
    </button>
    <button class="following" aria-label="Following" title="Following">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="9" cy="7" r="4" />
        <path d="M17 11v6" />
        <path d="M20 17v-3a4 4 0 0 0-8 0v3" />
      </svg>
      Following
    </button>
    <button class="profile" aria-label="Profile" title="Profile">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="7" r="4" />
        <path d="M5.5 21a8.38 8.38 0 0 1 13 0" />
      </svg>
      Profile
    </button>
  </footer>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const main = document.getElementById('main-content');
  const buttons = document.querySelectorAll('footer#bottom-menu button');

  // State placeholder
  const state = {
    currentSection: 'home',
    user: {
      profilePic: 'https://i.pravatar.cc/120',
      username: 'Loading...',
      handle: 'loading',
      email: 'loading@example.com',
      followers: 0,
      postViews: 0,
      followingList: [],
      posts: [],
      polls: []
    },
    uid: null,
  };

  function clearActive() {
    buttons.forEach(b => b.classList.remove('active'));
  }

  function preventSelectDuringEdit(e) {
    e.preventDefault();
  }

  function enableEditing(div) {
    div.contentEditable = true;
    div.focus();
    document.execCommand('selectAll', false, null);
    div.addEventListener('mousedown', preventSelectDuringEdit);
  }

  async function disableEditing(div, field) {
    div.contentEditable = false;
    div.removeEventListener('mousedown', preventSelectDuringEdit);

    const newVal = div.innerText.trim();
    if(field === 'username' && newVal) {
      state.user.username = newVal;
      await update(ref(db, `users/${state.uid}`), { username: newVal });
    } else if(field === 'handle') {
      const cleanHandle = newVal.replace(/^@/, '') || state.user.handle;
      state.user.handle = cleanHandle;
      div.innerText = '@' + cleanHandle;
      await update(ref(db, `users/${state.uid}`), { handle: cleanHandle });
    }
    renderProfile();
  }

  // Profile pic upload to Imgur
  async function uploadProfilePic(file) {
    if(!file) return;

    const clientId = 'YOUR_IMGUR_CLIENT_ID'; // You must replace with your actual Imgur Client ID
    const formData = new FormData();
    formData.append('image', file);

    try {
      const res = await fetch('https://api.imgur.com/3/image', {
        method: 'POST',
        headers: {
          Authorization: `Client-ID ${clientId}`
        },
        body: formData
      });
      const data = await res.json();
      if(data.success) {
        const url = data.data.link;
        // Update Firebase profilePic url
        await update(ref(db, `users/${state.uid}`), { profilePic: url });
        state.user.profilePic = url;
        renderProfile();
      } else {
        alert('Imgur upload failed');
      }
    } catch(e) {
      console.error('Imgur upload error', e);
      alert('Imgur upload error');
    }
  }

  // Render sections
  function renderHome() {
    main.innerHTML = '';
    if(state.user.posts.length === 0) {
      main.innerHTML = '<p>No posts yet.</p>';
      return;
    }
    state.user.posts.forEach(post => {
      const postEl = document.createElement('article');
      postEl.className = 'post';
      postEl.innerHTML = `<h2 class="post-title">${post.title}</h2><p class="post-body">${post.body}</p>`;
      main.appendChild(postEl);
    });
  }

  function renderCommunity() {
    main.innerHTML = '';
    if(state.user.polls.length === 0) {
      main.innerHTML = '<p>No polls or quizzes yet.</p>';
      return;
    }
    state.user.polls.forEach(poll => {
      const pollEl = document.createElement('div');
      pollEl.className = 'post';
      pollEl.innerHTML = `
        <h3 class="post-title">${poll.question}</h3>
        <ul>${poll.options.map(opt => `<li>${opt}</li>`).join('')}</ul>
      `;
      main.appendChild(pollEl);
    });
  }

  function renderFollowing() {
    main.innerHTML = '';
    if(state.user.followingList.length === 0) {
      main.innerHTML = '<p>No users followed yet.</p>';
      return;
    }
    state.user.followingList.forEach(user => {
      const userEl = document.createElement('div');
      userEl.className = 'post';
      userEl.innerHTML = `<strong>${user.name}</strong><br/><small>${user.handle}</small>`;
      main.appendChild(userEl);
    });
  }

  function renderProfile() {
    main.innerHTML = `
      <div class="profile-container">
        <img id="profile-pic" class="profile-pic" src="${state.user.profilePic}" alt="Profile Picture" style="cursor:pointer" title="Click to change profile picture" />
        
        <div>
          <div id="username" class="editable-field" tabindex="0" role="textbox" contenteditable="false">${state.user.username || 'No username'}</div>
          <div id="handle" class="editable-field handle" tabindex="0" role="textbox" contenteditable="false">@${state.user.handle || 'nohandle'}</div>
        </div>

        <div class="followers-count">${state.user.followers} Followers</div>

        <div class="progress-bars">
          <div>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${Math.min(100, (state.user.followers / 100) * 100)}%"></div>
            </div>
            <div class="progress-label">Followers (100 needed)</div>
          </div>
          <div>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${Math.min(100, (state.user.postViews / 1000) * 100)}%"></div>
            </div>
            <div class="progress-label">Post Views (1000 needed)</div>
          </div>
        </div>

        <div class="profile-info">
          <strong>Email:</strong> ${state.user.email}<br/><br/>
          <small>Click username or handle to edit. Press Enter to save.</small>
        </div>
      </div>
      <input type="file" id="file-input" accept="image/*" style="display:none" />
    `;

    const usernameDiv = document.getElementById('username');
    const handleDiv = document.getElementById('handle');
    const profilePicImg = document.getElementById('profile-pic');
    const fileInput = document.getElementById('file-input');

    usernameDiv.addEventListener('click', () => enableEditing(usernameDiv));
    handleDiv.addEventListener('click', () => enableEditing(handleDiv));

    usernameDiv.addEventListener('keydown', e => {
      if(e.key === 'Enter') {
        e.preventDefault();
        disableEditing(usernameDiv, 'username');
      }
      if(e.key === 'Escape') {
        e.preventDefault();
        renderProfile();
      }
    });

    handleDiv.addEventListener('keydown', e => {
      if(e.key === 'Enter') {
        e.preventDefault();
        disableEditing(handleDiv, 'handle');
      }
      if(e.key === 'Escape') {
        e.preventDefault();
        renderProfile();
      }
    });

    // Profile pic change handler
    profilePicImg.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if(file) {
        await uploadProfilePic(file);
      }
    });
  }

  // Load all relevant data from Firebase
  async function loadUserData(uid) {
    const dbRef = ref(db);

    try {
      // User data (profile, email, followers, followingList)
      const userSnap = await get(child(dbRef, `users/${uid}`));
      if(userSnap.exists()) {
        const userData = userSnap.val();
        state.user = {
          profilePic: userData.profilePic || 'https://i.pravatar.cc/120',
          username: userData.username || 'No username',
          handle: userData.handle || 'nohandle',
          email: userData.email || 'No email',
          followers: userData.followers || 0,
          postViews: userData.postViews || 0,
          followingList: userData.followingList || []
        };
      } else {
        console.warn(`No user data found for ${uid}, using fallbacks.`);
      }

      // Posts
      const postsSnap = await get(child(dbRef, 'posts'));
      if(postsSnap.exists()) {
        // Expect posts to be array or object, convert to array if needed
        const postsData = postsSnap.val();
        state.user.posts = Array.isArray(postsData) ? postsData : Object.values(postsData);
      } else {
        state.user.posts = [];
      }

      // Community polls & quizzes
      const communitySnap = await get(child(dbRef, 'community'));
      if(communitySnap.exists()) {
        const communityData = communitySnap.val();
        // communityData may have polls and quizzes as separate properties
        // merge them into polls array
const polls = [];
        if (communityData.polls) polls.push(...Object.values(communityData.polls));
        if (communityData.quizzes) polls.push(...Object.values(communityData.quizzes));
        state.user.polls = polls;
      } else {
        state.user.polls = [];
      }
      
      renderCurrentSection();
    } catch (error) {
      console.error('Error loading data:', error);
      // Render anyway so user sees something
      renderCurrentSection();
    }
  }

  // Render current section based on state
  function renderCurrentSection() {
    switch(state.currentSection) {
      case 'home': renderHome(); break;
      case 'community': renderCommunity(); break;
      case 'following': renderFollowing(); break;
      case 'profile': renderProfile(); break;
      default: renderHome();
    }
  }

  // Handle section button clicks
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      if(btn.classList.contains('active')) return;
      clearActive();
      btn.classList.add('active');
      state.currentSection = btn.classList[0];
      renderCurrentSection();
    });
  });

  // On Auth State Changed, load user data with uid
  onAuthStateChanged(auth, user => {
    if (user) {
      state.uid = user.uid;
      loadUserData(user.uid);
    } else {
      // No user signed in, fallback to dummy user or prompt login
      console.warn('No user logged in.');
      // You could redirect to login or show message here
      // For now, fallback dummy data render
      renderCurrentSection();
    }
  });
</script>
</body>
</html>