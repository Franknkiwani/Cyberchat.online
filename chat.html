<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CYBERCHAT - Clean Feed with Top Search</title>
<style>
  :root {
    --bg: #0a0a0a;
    --panel: #161616;
    --border: #222;
    --text: #f1f1f1;
    --pink: #ff2e88;
    --blue: #1e90ff;
    --input-bg: #1c1c1c;
    --overlay-bg: rgba(10, 10, 10, 0.8);
  }
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body, html {
    height: 100%;
    background-color: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-weight: bold;
    overflow-x: hidden;
  }

  header {
    height: 56px;
    background-color: var(--panel);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 1000;
    transition: opacity 0.3s ease;
  }

  .left-icons, .right-icons {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .icon svg {
    width: 20px;
    height: 20px;
    fill: var(--text);
    cursor: pointer;
    transition: fill 0.2s;
  }
  .icon svg:hover {
    fill: var(--pink);
  }

  .brand {
    font-size: 20px;
    letter-spacing: 1px;
    color: var(--text);
  }
  .brand .cyber {
    color: var(--pink);
  }
  .brand .chat {
    color: var(--blue);
  }

  main.feed {
    max-width: 700px;
    margin: 24px auto;
    padding: 0 16px;
    transition: filter 0.3s ease;
  }

  /* Composer */
  .composer {
    background-color: var(--input-bg);
    padding: 12px 16px;
    border-radius: 10px;
    border: 1px solid var(--border);
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
  }
  .composer .left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
  }
  .composer img {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
  }
  .composer input {
    width: 100%;
    background: transparent;
    border: none;
    outline: none;
    font-size: 16px;
    color: var(--text);
    font-weight: bold;
  }
  .composer input::placeholder {
    color: #777;
  }
  .composer .gallery-icon svg {
    width: 22px;
    height: 22px;
    fill: var(--blue);
    cursor: pointer;
    transition: fill 0.2s;
  }
  .composer .gallery-icon svg:hover {
    fill: var(--pink);
  }

  /* Top search bar */
  .search-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 56px;
    background: var(--panel);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--pink);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 12px;
    transform: translateY(-100%);
    transition: transform 0.3s ease;
    z-index: 1500;
  }
  .search-bar.active {
    transform: translateY(0);
  }
  .search-bar svg {
    width: 24px;
    height: 24px;
    fill: var(--pink);
  }
  .search-bar input {
    flex: 1;
    background: var(--input-bg);
    border: none;
    border-radius: 12px;
    padding: 8px 16px;
    font-size: 18px;
    color: var(--text);
    font-weight: bold;
    outline: none;
    caret-color: var(--pink);
  }
  .search-bar input::placeholder {
    color: #777;
  }

  /* Background blur overlay while search open */
  .blur-overlay {
    position: fixed;
    top: 56px; /* below the search bar */
    left: 0; right: 0; bottom: 0;
    backdrop-filter: blur(6px);
    background: rgba(0,0,0,0.6);
    z-index: 1400;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .blur-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }

  /* Suggestions box */
  .suggestions {
    position: fixed;
    top: 56px;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 600px;
    background: var(--panel);
    border-radius: 12px;
    padding: 12px 16px;
    box-shadow: 0 0 12px var(--blue);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1600;
    color: var(--text);
    font-weight: normal;
    display: none;
  }
  .suggestions.active {
    display: block;
  }
  .suggestion-item {
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .suggestion-item:hover, .suggestion-item:focus {
    background: var(--pink);
    color: var(--bg);
    outline: none;
  }
  .no-results {
    color: #777;
    text-align: center;
    padding: 20px 0;
  }
  .search-results {
  margin-top: 1rem;
  padding: 1rem;
}
.post-card {
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 1rem;
  background: white;
}
.not-found, .error {
  padding: 2rem;
  text-align: center;
  font-size: 1.2rem;
  color: #888;
}
</style>
</head>
<body>

<header>
  <div class="left-icons icon" id="search-icon" tabindex="0" role="button" aria-label="Open search">
    <!-- Search SVG -->
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M10 2a8 8 0 105.293 14.707l5 5a1 1 0 001.414-1.414l-5-5A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/>
    </svg>
    <span style="margin-left:6px; font-weight: normal; font-size: 16px; color: var(--text);">Search</span>
  </div>

  <div class="brand">
    <span class="cyber">CYBER</span><span class="chat">CHAT</span>
  </div>

  <div class="right-icons icon" tabindex="0" role="button" aria-label="Settings">
    <!-- Settings SVG -->
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 15a3 3 0 100-6 3 3 0 000 6zm9-3a7.986 7.986 0 01-.535 2.915l2.122 1.652-1.5 2.598-2.512-.647A7.986 7.986 0 0112 21a7.986 7.986 0 01-2.915-.535l-1.652 2.122-2.598-1.5.647-2.512A7.986 7.986 0 013 12c0-.997.181-1.953.535-2.915L1.413 7.433l1.5-2.598 2.512.647A7.986 7.986 0 0112 3a7.986 7.986 0 012.915.535l1.652-2.122 2.598 1.5-.647 2.512A7.986 7.986 0 0121 12z"/>
    </svg>
  </div>
</header>

<main class="feed">
  <div class="composer">
    <div class="left">
      <img src="https://i.pravatar.cc/150?u=user" alt="User" />
      <input type="text" placeholder="What's on your mind?" />
    </div>
    <div class="gallery-icon" tabindex="0" role="button" aria-label="Upload from gallery">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M21 19V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2zM5 5h14v9.586l-3.293-3.293a1 1 0 00-1.414 0L12 14.586l-2.293-2.293a1 1 0 00-1.414 0L5 15.586V5zm0 14v-.586l5-5 2.293 2.293a1 1 0 001.414 0L19 10.414V19H5z"/>
      </svg>
    </div>
  </div>

  <!-- Your feed posts would go here -->
</main>

<!-- continuing inside body, after main.feed -->

<!-- Top Search Bar -->
<div class="search-bar" id="search-bar" aria-hidden="true" role="search">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
    <path d="M10 2a8 8 0 105.293 14.707l5 5a1 1 0 001.414-1.414l-5-5A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/>
  </svg>
  <input
    type="search"
    id="search-input"
    placeholder="Search CYBERCHAT..."
    aria-label="Search CYBERCHAT"
    autocomplete="off"
    spellcheck="false"
  />
</div>

<!-- Background blur overlay while search open -->
<div class="blur-overlay" id="blur-overlay" tabindex="-1" aria-hidden="true"></div>

<!-- Suggestions Box -->
<div class="suggestions" id="suggestions" role="listbox" aria-label="Search suggestions"></div>
<div id="search-results" class="search-results"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    get,
    child
  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const dbRef = ref(db);

  const searchIcon = document.getElementById('search-icon');
  const searchBar = document.getElementById('search-bar');
  const blurOverlay = document.getElementById('blur-overlay');
  const searchInput = document.getElementById('search-input');
  const suggestionsBox = document.getElementById('suggestions');
  const header = document.querySelector('header');
  const mainFeed = document.querySelector('main.feed');
  const resultsBox = document.getElementById('search-results');

  let activeIndex = -1;
  let filtered = []; // will hold {id, title, views, thumbnailUrl}

  function openSearch() {
    searchBar.classList.add('active');
    blurOverlay.classList.add('active');
    searchBar.setAttribute('aria-hidden', 'false');
    blurOverlay.setAttribute('aria-hidden', 'false');
    header.style.opacity = '0';
    mainFeed.style.filter = 'blur(6px) brightness(0.7)';
    searchInput.focus();
    clearSuggestions();
    resultsBox.innerHTML = '';
  }

  function closeSearch() {
    searchBar.classList.remove('active');
    blurOverlay.classList.remove('active');
    searchBar.setAttribute('aria-hidden', 'true');
    blurOverlay.setAttribute('aria-hidden', 'true');
    header.style.opacity = '1';
    mainFeed.style.filter = 'none';
    searchInput.value = '';
    clearSuggestions();
    resultsBox.innerHTML = '';
  }

  function clearSuggestions() {
    suggestionsBox.classList.remove('active');
    suggestionsBox.innerHTML = '';
    activeIndex = -1;
  }

  function renderSuggestions() {
    if (filtered.length === 0) {
      suggestionsBox.innerHTML = `<div class="no-results">No results found</div>`;
      suggestionsBox.classList.add('active');
      return;
    }
    suggestionsBox.innerHTML = '';
    filtered.forEach((item, i) => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.setAttribute('role', 'option');
      div.setAttribute('tabindex', '0');
      div.dataset.id = item.id;

      div.innerHTML = `
        <img src="${item.thumbnailUrl}" alt="Thumbnail" class="suggestion-thumb" />
        <div class="suggestion-text">
          <div class="suggestion-title">${item.title}</div>
          <div class="suggestion-views">${item.views} views</div>
        </div>
      `;

      if (i === activeIndex) div.classList.add('active');
      suggestionsBox.appendChild(div);
    });
    suggestionsBox.classList.add('active');
  }

  async function updateSuggestions() {
    const val = searchInput.value.trim().toLowerCase();
    if (!val) {
      clearSuggestions();
      return;
    }

    try {
      const snapshot = await get(child(dbRef, 'post'));
      if (!snapshot.exists()) {
        clearSuggestions();
        return;
      }
      const data = snapshot.val();

      filtered = Object.entries(data)
        .filter(([id, post]) => post.title && post.title.toLowerCase().includes(val))
        .map(([id, post]) => ({
          id,
          title: post.title,
          views: post.views || 0,
          thumbnailUrl: post.thumbnailUrl || 'https://via.placeholder.com/48?text=No+Img'
        }));

      activeIndex = -1;
      renderSuggestions();

    } catch (err) {
      console.error('Error fetching suggestions:', err);
      clearSuggestions();
    }
  }

  function debounce(func, delay = 300) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  function triggerSearch(query) {
    console.log('Search triggered for:', query);
    const event = new CustomEvent('search', { detail: query });
    document.dispatchEvent(event);
  }

  // NEW: relevance scoring for search feed sorting
  function relevanceScore(query, text) {
    if (!text) return 0;
    query = query.toLowerCase();
    text = text.toLowerCase();
    if (text === query) return 100;
    if (text.includes(query)) return 50;
    let score = 0;
    for (const c of query) {
      if (text.includes(c)) score++;
    }
    return score;
  }

  // NEW: render the full search results feed, featured post on top, related posts below
  function renderSearchResults(posts, query) {
    if (!posts.length) {
      resultsBox.innerHTML = `<div class="no-results">No posts found for "${query}"</div>`;
      return;
    }

    // Sort posts by relevance descending
    posts.sort((a,b) => relevanceScore(query, b.title) - relevanceScore(query, a.title));

    // Featured post is the top one
    const featured = posts[0];
    const others = posts.slice(1);

    let html = `
      <h2>Search results for "${query}"</h2>
      <section class="featured-post">
        <h3>${featured.title}</h3>
        <img src="${featured.thumbnailUrl || 'https://via.placeholder.com/200?text=No+Image'}" alt="Thumbnail" />
        <p>${featured.body || 'No content available'}</p>
        <small>By ${featured.author || 'Unknown'} | ${featured.views || 0} views</small>
      </section>
      <hr/>
      <section class="other-posts">
        <h4>Related posts</h4>
        <ul>
    `;

    others.forEach(post => {
      html += `
        <li class="search-post-item" data-id="${post.id}" tabindex="0" role="button" aria-pressed="false">
          <img src="${post.thumbnailUrl || 'https://via.placeholder.com/48?text=No+Img'}" alt="Thumbnail" />
          <div>
            <strong>${post.title}</strong><br/>
            <small>${post.views || 0} views</small>
          </div>
        </li>
      `;
    });

    html += '</ul></section>';
    resultsBox.innerHTML = html;

    // Click & keyboard to feature other posts
    document.querySelectorAll('.search-post-item').forEach(item => {
      item.addEventListener('click', () => {
        const id = item.dataset.id;
        const post = posts.find(p => p.id === id);
        if (!post) return;
        renderSearchResults([post, ...posts.filter(p => p.id !== id)], query);
      });
      item.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          item.click();
        }
      });
    });
  }

  // NEW: full search triggered on search input Enter or suggestion click
  async function doFullSearch(query) {
    closeSearch(); // unblur & hide search UI
    try {
      const snapshot = await get(child(dbRef, 'post'));
      if (!snapshot.exists()) {
        resultsBox.innerHTML = `<div class="no-results">No posts found</div>`;
        return;
      }
      const data = snapshot.val();
      const allPosts = Object.entries(data).map(([id, post]) => ({
        id,
        title: post.title || '',
        views: post.views || 0,
        thumbnailUrl: post.thumbnailUrl || 'https://via.placeholder.com/48?text=No+Img',
        body: post.body || '',
        author: post.author || 'Unknown'
      }));

      renderSearchResults(allPosts, query);

    } catch (err) {
      console.error('Search error:', err);
      resultsBox.innerHTML = `<div class="error">Error loading search results</div>`;
    }
  }

  // Replace old fetchAndShowPost to do nothing now (we use renderSearchResults instead)
  async function fetchAndShowPost(postId) {
    // Intentionally blank because we're handling full feed rendering now
  }

  // Event listeners wiring

  searchIcon.addEventListener('click', openSearch);
  blurOverlay.addEventListener('click', closeSearch);

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && searchBar.classList.contains('active')) {
      closeSearch();
    }
  });

  searchInput.addEventListener('input', debounce(updateSuggestions));

  searchInput.addEventListener('keydown', e => {
    if (!filtered.length) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeIndex = (activeIndex + 1) % filtered.length;
      renderSuggestions();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeIndex = (activeIndex - 1 + filtered.length) % filtered.length;
      renderSuggestions();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (activeIndex >= 0) {
        const selected = filtered[activeIndex];
        searchInput.value = selected.title;
        doFullSearch(selected.title);
        clearSuggestions();
        triggerSearch(selected.title);
      } else {
        const query = searchInput.value.trim();
        if (query) {
          doFullSearch(query);
          clearSuggestions();
          triggerSearch(query);
        }
      }
    }
  });

  suggestionsBox.addEventListener('click', e => {
    const item = e.target.closest('.suggestion-item');
    if (!item) return;
    const title = item.querySelector('.suggestion-title').textContent;
    searchInput.value = title;
    doFullSearch(title);
    clearSuggestions();
    triggerSearch(title);
  });

  suggestionsBox.addEventListener('keydown', e => {
    if (e.key === 'Enter' && e.target.classList.contains('suggestion-item')) {
      const title = e.target.querySelector('.suggestion-title').textContent;
      searchInput.value = title;
      doFullSearch(title);
      clearSuggestions();
      triggerSearch(title);
    }
  });
</script>
</body>
</html>