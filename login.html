<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Post Creator - CyberChat</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
  import { getDatabase, ref, get, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

  // === YOUR FIREBASE CONFIG - REPLACE THESE VALUES ===
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const imgurClientID = "891e5bb4aa94282"; // Your Imgur Client ID

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let currentUser = null;
  let userProfile = null;

  window.addEventListener('DOMContentLoaded', () => {
    const profilePicEl = document.getElementById('profile-pic');
    const usernameEl = document.getElementById('username');
    const postForm = document.getElementById('post-form');
    const postText = document.getElementById('post-text');
    const postImageInput = document.getElementById('post-image');
    const submitBtn = document.getElementById('submit-btn');
    const messageBox = document.getElementById('message-box');

    // Show message on the page
    function showMessage(text, isError = false) {
      messageBox.textContent = text;
      messageBox.style.color = isError ? 'tomato' : 'lightgreen';
      messageBox.style.opacity = '1';
      setTimeout(() => {
        messageBox.style.opacity = '0';
      }, 4000);
    }

    function resetForm() {
      postText.value = '';
      postImageInput.value = '';
    }

    // Upload image to Imgur
    async function uploadImageToImgur(file) {
      const formData = new FormData();
      formData.append('image', file);

      const res = await fetch('https://api.imgur.com/3/image', {
        method: 'POST',
        headers: {
          Authorization: 'Client-ID ' + imgurClientID,
        },
        body: formData,
      });

      const data = await res.json();
      if (!res.ok || !data.success) throw new Error('Imgur upload failed: ' + (data.data?.error || res.status));
      return data.data.link;
    }

    // Handle form submit
    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser || !userProfile) {
        showMessage('User not authenticated.', true);
        return;
      }
      if (!postText.value.trim()) {
        showMessage('Post text cannot be empty.', true);
        return;
      }

      submitBtn.disabled = true;
      showMessage('Uploading post...', false);

      try {
        let imageUrl = '';
        if (postImageInput.files.length > 0) {
          imageUrl = await uploadImageToImgur(postImageInput.files[0]);
        }

        // Save post in Firebase
        const postsRef = ref(db, 'posts');
        await push(postsRef, {
          uid: currentUser.uid,
          username: userProfile.username || 'Unknown',
          profilePic: userProfile.profilePic || '',
          text: postText.value.trim(),
          image: imageUrl,
          createdAt: serverTimestamp(),
        });

        showMessage('Post uploaded successfully!');
        resetForm();
      } catch (err) {
        console.error(err);
        showMessage('Error: ' + err.message, true);
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Watch auth state and fetch profile
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        try {
          const userRef = ref(db, `users/${user.uid}`);
          const snapshot = await get(userRef);
          if (snapshot.exists()) {
            userProfile = snapshot.val();
            usernameEl.textContent = userProfile.username || 'Unknown User';
            profilePicEl.src = userProfile.profilePic || 'https://via.placeholder.com/50?text=User';
          } else {
            userProfile = { username: 'Unknown User', profilePic: 'https://via.placeholder.com/50?text=User' };
            usernameEl.textContent = userProfile.username;
            profilePicEl.src = userProfile.profilePic;
          }
        } catch (e) {
          console.error('Failed to fetch user profile:', e);
          userProfile = { username: 'Unknown User', profilePic: 'https://via.placeholder.com/50?text=User' };
          usernameEl.textContent = userProfile.username;
          profilePicEl.src = userProfile.profilePic;
        }
      } else {
        currentUser = null;
        userProfile = null;
        usernameEl.textContent = 'Not logged in';
        profilePicEl.src = 'https://via.placeholder.com/50?text=User';
      }
    });
  });
</script>

<style>
  body {
    background: #0f172a;
    color: white;
    font-family: 'Inter', sans-serif;
    padding: 1rem;
  }
  .header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .header img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
  }
  #message-box {
    margin-top: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    font-weight: 600;
  }
  form > * {
    display: block;
    width: 100%;
    margin-bottom: 1rem;
  }
  textarea {
    resize: vertical;
    min-height: 100px;
    padding: 0.5rem;
    font-size: 1rem;
  }
  input[type="file"] {
    color: white;
  }
  button {
    background: #06b6d4;
    border: none;
    padding: 0.75rem 1.5rem;
    font-weight: 700;
    cursor: pointer;
    border-radius: 0.375rem;
    transition: background 0.3s ease;
  }
  button:disabled {
    background: #4dd0e1;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background: #0891b2;
  }
</style>
</head>
<body>

  <div class="header">
    <img id="profile-pic" src="https://via.placeholder.com/50?text=User" alt="Profile Picture" />
    <div id="username">Loading user...</div>
  </div>

  <form id="post-form" autocomplete="off">
    <textarea id="post-text" placeholder="What's on your mind?" required></textarea>
    <input type="file" id="post-image" accept="image/*" />
    <button id="submit-btn" type="submit">Post This Magic</button>
  </form>

  <div id="message-box"></div>

</body>
</html>