<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CYBERCHAT - Create Post</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body {
      background: #0f172a;
      font-family: 'Inter', sans-serif;
      color: white;
    }
    .glass {
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    input, textarea {
      background: rgba(255,255,255,0.1);
      border: none;
      padding: 0.75rem;
      border-radius: 0.5rem;
      color: white;
    }
    input::placeholder, textarea::placeholder {
      color: rgba(255,255,255,0.6);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-6">

  <header class="glass w-full max-w-xl rounded-2xl p-4 mb-8 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <i data-lucide="message-square" class="w-6 h-6 text-cyan-400"></i>
      <h1 class="text-xl font-bold">Create Post</h1>
    </div>
    <img id="profilePic" src="https://via.placeholder.com/40" alt="Profile" class="rounded-full w-10 h-10 object-cover" />
  </header>

  <form id="postForm" class="glass w-full max-w-xl p-6 rounded-3xl flex flex-col gap-6" autocomplete="off">
    <input type="text" id="title" placeholder="Post Title" maxlength="100" required />
    <textarea id="description" placeholder="What's on your mind, Boss?" rows="5" maxlength="1000" required></textarea>

    <label class="flex flex-col gap-1 cursor-pointer">
      <span>Upload Image <span class="text-red-500">*</span></span>
      <input type="file" id="imageInput" accept="image/*" required />
    </label>

    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 transition rounded-xl py-3 font-semibold" id="submitBtn">
      Post This Magic
    </button>
  </form>

  <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.filestorage.app",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import { getDatabase, ref, push, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const profilePicEl = document.getElementById("profilePic");
    const postForm = document.getElementById("postForm");
    const titleInput = document.getElementById("title");
    const descInput = document.getElementById("description");
    const imageInput = document.getElementById("imageInput");
    const submitBtn = document.getElementById("submitBtn");

    let currentUser = null;
    let userData = null;

    // Imgur config
    const IMGUR_CLIENT_ID = "891e5bb4aa94282";

    // Show logged in user profile pic & name
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        // Load user data from Firebase
        const userRef = ref(db, `users/${user.uid}`);
        const snapshot = await new Promise(res => {
          const unsubscribe = onValue(userRef, snap => {
            res(snap);
            unsubscribe();
          });
        });

        userData = snapshot.exists() ? snapshot.val() : null;

        if (userData?.profilePic) profilePicEl.src = userData.profilePic;
        else profilePicEl.src = "https://via.placeholder.com/40?text=User";

      } else {
        alert("Please log in first");
        // Redirect or show login
        location.href = "/login.html"; // or wherever
      }
    });

    // Upload image to Imgur
    async function uploadToImgur(file) {
      const formData = new FormData();
      formData.append('image', file);

      const res = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
          Authorization: "Client-ID " + IMGUR_CLIENT_ID,
        },
        body: formData,
      });
      const data = await res.json();
      if (data.success) {
        return data.data.link;
      } else {
        throw new Error("Imgur upload failed");
      }
    }

    postForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return alert("You must be logged in");

      if (!imageInput.files[0]) {
        alert("Please select an image");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Uploading...";

      try {
        // Upload image first
        const imgUrl = await uploadToImgur(imageInput.files[0]);

        // Prepare post data
        const postData = {
          userId: currentUser.uid,
          username: userData?.username || "Unknown",
          profilePic: userData?.profilePic || "",
          title: titleInput.value.trim(),
          description: descInput.value.trim(),
          imageUrl: imgUrl,
          likesCount: 0,
          commentsCount: 0,
          createdAt: Date.now()
        };

        // Save post to Firebase Realtime Database
        const postsRef = ref(db, "posts");
        const newPostRef = push(postsRef);
        await set(newPostRef, postData);

        alert("Post created successfully!");

        // Reset form
        postForm.reset();

      } catch (err) {
        alert("Error creating post: " + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Post This Magic";
      }
    });

    lucide.createIcons();
  </script>
</body>
</html>