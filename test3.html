<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CyberChat Studio Dashboard</title>
  <style>
    /* iOS 30 style small, neat, glass */
    body {3
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      background: #0a0a0a;
      color: #eee;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header {
      backdrop-filter: blur(12px);
      background: rgba(255 255 255 / 0.05);
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      letter-spacing: 1.2px;
      border-bottom: 1px solid rgba(255 255 255 / 0.1);
      user-select: none;
    }
    main {
      padding: 10px 15px;
      max-width: 400px;
      margin: auto;
    }
    .stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .stat {
      flex: 1;
      text-align: center;
      padding: 6px 0;
      border-radius: 8px;
      margin: 0 5px;
      background: rgba(255 255 255 / 0.06);
      user-select: none;
    }
    .stat strong {
      display: block;
      font-size: 22px;
      margin-bottom: 2px;
      font-weight: 700;
    }
    #details {
      margin-top: 12px;
      background: rgba(255 255 255 / 0.07);
      border-radius: 8px;
      padding: 8px;
      font-size: 13px;
      max-height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.4;
      user-select: text;
    }
    canvas {
      user-select: none;
    }
  </style>
</head>
<body>
  <header>CYBERCHAT STUDIO</header>
  <main>
    <div class="stats">
      <div class="stat" id="viewsStat"><strong>0</strong>Views</div>
      <div class="stat" id="followersStat"><strong>0</strong>Followers</div>
      <div class="stat" id="earningsStat"><strong>$0.00</strong>Earnings</div>
    </div>
    <canvas id="statsChart" width="400" height="200"></canvas>
    <div id="details"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      get,
      child,
      update,
      increment
    } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    import Chart from 'https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.esm.min.js';

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM refs
    const viewsStat = document.getElementById('viewsStat').querySelector('strong');
    const followersStat = document.getElementById('followersStat').querySelector('strong');
    const earningsStat = document.getElementById('earningsStat').querySelector('strong');
    const detailsDiv = document.getElementById('details');

    // Data holders
    let postsData = {};
    let chart;

    // Setup chart with empty data first
    function createChart() {
      const ctx = document.getElementById('statsChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Views',
              data: [],
              borderColor: '#00ffff',
              backgroundColor: 'rgba(0,255,255,0.2)',
              tension: 0.3,
              fill: true,
              pointRadius: 6,
              pointHoverRadius: 8,
              pointHoverBorderWidth: 2
            },
            {
              label: 'Followers',
              data: [],
              borderColor: '#ff7f00',
              backgroundColor: 'rgba(255,127,0,0.2)',
              tension: 0.3,
              fill: true,
              pointRadius: 6,
              pointHoverRadius: 8,
              pointHoverBorderWidth: 2
            },
            {
              label: 'Earnings',
              data: [],
              borderColor: '#00ff00',
              backgroundColor: 'rgba(0,255,0,0.2)',
              tension: 0.3,
              fill: true,
              pointRadius: 6,
              pointHoverRadius: 8,
              pointHoverBorderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'nearest',
            intersect: true,
          },
          plugins: {
            legend: { labels: { color: '#eee', font: { size: 14 } } },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => {
                  let label = ctx.dataset.label || '';
                  if (label) label += ': ';
                  label += ctx.parsed.y;
                  if (label.includes('Earnings')) label = label.replace(/(\d+)/, (v) => `$${parseFloat(v).toFixed(2)}`);
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#aaa' }
            },
            x: {
              ticks: { color: '#aaa' }
            }
          },
          onClick: (evt, elements) => {
            if (!elements.length) return;
            const index = elements[0].index;
            const datasetIndex = elements[0].datasetIndex;
            const label = chart.data.labels[index];
            if (datasetIndex === 0) { // Views clicked
              showViewDetails(label);
            } else {
              detailsDiv.textContent = '';
            }
          }
        }
      });
    }

    // Show details for views for the given label (postId here)
    async function showViewDetails(postId) {
      const viewDetailsRef = ref(db, `posts/${postId}/viewDetails`);
      const snapshot = await get(viewDetailsRef);
      const viewDetails = snapshot.val();
      if (!viewDetails) {
        detailsDiv.textContent = 'No detailed view data available.';
        return;
      }
      let text = `View Details for Post "${postId}":\n\n`;
      for (const userId in viewDetails) {
        const ts = new Date(viewDetails[userId].timestamp).toLocaleString();
        text += `User: ${userId}, Viewed At: ${ts}\n`;
      }
      detailsDiv.textContent = text;
    }

    // Load posts and update dashboard & chart live
    function loadPostsLive() {
      const postsRef = ref(db, 'posts');
      onValue(postsRef, (snapshot) => {
        postsData = snapshot.val() || {};

        // Aggregate totals
        let totalViews = 0, totalFollowers = 0, totalEarnings = 0;
        const labels = [];
        const viewsData = [];
        const followersData = [];
        const earningsData = [];

        for (const postId in postsData) {
          const post = postsData[postId];
          labels.push(postId);
          const views = post.views || 0;
          const followers = post.followers || 0;
          const earnings = post.earnings || 0;
          totalViews += views;
          totalFollowers += followers;
          totalEarnings += earnings;

          viewsData.push(views);
          followersData.push(followers);
          earningsData.push(earnings);
        }

        // Update stats UI
        viewsStat.textContent = totalViews;
        followersStat.textContent = totalFollowers;
        earningsStat.textContent = `$${totalEarnings.toFixed(2)}`;

        // Update chart
        chart.data.labels = labels;
        chart.data.datasets[0].data = viewsData;
        chart.data.datasets[1].data = followersData;
        chart.data.datasets[2].data = earningsData;
        chart.update();

        // Clear details on update
        detailsDiv.textContent = '';
      });
    }

    // Init
    createChart();
    loadPostsLive();
  </script>
</body>
</html>