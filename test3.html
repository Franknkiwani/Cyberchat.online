<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firebase Multi-Tab Demo</title>
<style>
  /* Basic styling for tabs and cards */
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background: #f0f2f5;
    margin: 0; padding: 0;
  }
  nav {
    display: flex;
    background: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  nav div.tab {
    flex: 1;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    user-select: none;
    font-weight: 600;
  }
  nav div.tab.active {
    border-bottom: 3px solid #007aff;
    color: #007aff;
  }
  .content {
    display: none;
    padding: 1rem;
  }
  .content.active {
    display: block;
  }
  .card {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
  }
  .post-title, .poll-quiz-title, .user-name {
    font-weight: 700;
    font-size: 1.1rem;
  }
  .post-body, .poll-quiz-body {
    margin-top: 0.5rem;
    color: #444;
  }
  .unfollow-btn {
    margin-top: 0.5rem;
    padding: 0.3rem 0.6rem;
    background: #ff3b30;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
</style>
</head>
<body>

<nav>
  <div class="tab active" onclick="switchTab('home')">Home</div>
  <div class="tab" onclick="switchTab('community')">Community</div>
  <div class="tab" onclick="switchTab('following')">Following</div>
</nav>

<div id="homePage" class="content active">
  <p>Loading posts...</p>
</div>
<div id="communityPage" class="content">
  <p>Loading community content...</p>
</div>
<div id="followingPage" class="content">
  <p>Loading following list...</p>
</div>

<script type="module">
// Your Firebase config + imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
import { getDatabase, ref, get, child, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
  measurementId: "G-LLT6F9WRKH"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);
const auth = getAuth(app);

const homePage = document.getElementById('homePage');
const communityPage = document.getElementById('communityPage');
const followingPage = document.getElementById('followingPage');

let currentUser = null;

const sanitize = str => {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
};

window.switchTab = function(tab) {
  document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tab + 'Page').classList.add('active');
  [...document.querySelectorAll('.tab')]
    .find(t => t.textContent.toLowerCase() === tab)
    .classList.add('active');

  if (tab === 'home') loadHomePosts();
  else if (tab === 'community') loadCommunity();
  else if (tab === 'following') loadFollowing();
};

async function loadHomePosts() {
  homePage.innerHTML = '<p style="text-align:center;padding-top:1rem;">Loading posts...</p>';
  try {
    const snapshot = await get(ref(db, 'post'));
    if (!snapshot.exists()) {
      homePage.innerHTML = '<p>No posts yet.</p>';
      return;
    }
    const posts = snapshot.val();
    let html = '';
    for (const id in posts) {
      const post = posts[id];
      html += `
        <div class="card">
          <div class="post-title">${sanitize(post.title || 'Untitled')}</div>
          <div class="post-body">${sanitize(post.description || '')}</div>
        </div>`;
    }
    homePage.innerHTML = html;
  } catch (e) {
    console.error(e);
    homePage.innerHTML = '<p>Error loading posts.</p>';
  }
}

async function loadCommunity() {
  communityPage.innerHTML = '<p style="text-align:center;padding-top:1rem;">Loading community...</p>';
  try {
    const pollsSnap = await get(ref(db, 'polls'));
    const quizSnap = await get(ref(db, 'quiz'));
    const polls = pollsSnap.exists() ? pollsSnap.val() : {};
    const quizzes = quizSnap.exists() ? quizSnap.val() : {};

    const combined = [];
    for (const key in polls) combined.push({ id: key, type: 'Poll', ...polls[key] });
    for (const key in quizzes) combined.push({ id: key, type: 'Quiz', ...quizzes[key] });

    if (!combined.length) {
      communityPage.innerHTML = '<p>No polls or quizzes available.</p>';
      return;
    }
    // Sort by timestamp descending if available
    combined.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

    let html = '';
    combined.forEach(item => {
      html += `
      <div class="card">
        <div class="poll-quiz-title">${sanitize(item.title || 'Untitled')} <small style="color:#888">[${item.type}]</small></div>
        <div class="poll-quiz-body">${sanitize(item.description || '')}</div>
      </div>`;
    });

    communityPage.innerHTML = html;
  } catch (e) {
    console.error(e);
    communityPage.innerHTML = '<p>Error loading community content.</p>';
  }
}

async function loadFollowing() {
  if (!currentUser) {
    followingPage.innerHTML = '<p>Please log in to see who you are following.</p>';
    return;
  }

  followingPage.innerHTML = '<p style="text-align:center;padding-top:1rem;">Loading following...</p>';
  try {
    // Get following uids
    const followingSnap = await get(ref(db, `following/${currentUser.uid}`));
    if (!followingSnap.exists()) {
      followingPage.innerHTML = '<p>You are not following anyone.</p>';
      return;
    }
    const following = followingSnap.val(); // Assume format { uid: true, ... }

    // Now get user info for each followed uid
    let html = '';
    for (const followedUid in following) {
      // fetch profile data for followedUid
      const userSnap = await get(ref(db, `profile/${followedUid}`));
      if (!userSnap.exists()) continue;
      const user = userSnap.val();

      // user should have username, handle (or fallback)
      const username = sanitize(user.username || 'Unknown');
      const handle = sanitize(user.handle || '@unknown');

      html += `
      <div class="card">
        <div class="user-name">${username} <small style="color:#666">${handle}</small></div>
        <button class="unfollow-btn" onclick="unfollowUser('${followedUid}')">Unfollow</button>
      </div>`;
    }
    followingPage.innerHTML = html || '<p>No followed users found.</p>';
  } catch (e) {
    console.error(e);
    followingPage.innerHTML = '<p>Error loading following list.</p>';
  }
}

window.unfollowUser = async function(uidToUnfollow) {
  if (!currentUser) return alert('Not logged in');
  if (!confirm('Unfollow this user?')) return;

  try {
    await remove(ref(db, `following/${currentUser.uid}/${uidToUnfollow}`));
    alert('Unfollowed successfully');
    loadFollowing();
  } catch (e) {
    console.error(e);
    alert('Error unfollowing user.');
  }
};

onAuthStateChanged(auth, user => {
  currentUser = user;
  if (!user) {
    // Not logged in - can show guest view or prompt login
    homePage.innerHTML = '<p>Please log in to see posts.</p>';
    communityPage.innerHTML = '<p>Please log in to see community content.</p>';
    followingPage.innerHTML = '<p>Please log in to see who you follow.</p>';
  } else {
    // Load default tab data when user logs in
    loadHomePosts();
  }
});
</script>

</body>
</html>