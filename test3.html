<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>iPhone Style Tabs with Firebase Content</title>
<style>
  /* Reset + basics */
  body {
    margin: 0; 
    background: #f0f0f5;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    color: #111;
    -webkit-font-smoothing: antialiased;
  }
  /* Top tab container */
  .tab-bar {
    display: flex;
    justify-content: space-around;
    background: linear-gradient(145deg, #f8f8f8, #e0e0e0);
    padding: 12px 0;
    box-shadow:
      0 5px 10px rgba(0,0,0,0.05),
      inset 0 -1px 0 #ccc;
    position: sticky;
    top: 0;
    z-index: 100;
    border-radius: 0 0 18px 18px;
    margin-bottom: 10px;
  }
  /* Tab buttons with iOS 3D style */
  .tab-bar button {
    background: linear-gradient(145deg, #ffffff, #d7d7d7);
    border: none;
    border-radius: 15px;
    box-shadow:
      5px 5px 8px #bebebe,
      -5px -5px 8px #ffffff;
    padding: 8px 18px;
    font-weight: 600;
    font-size: 16px;
    color: #444;
    cursor: pointer;
    transition: all 0.25s ease;
    flex: 1;
    margin: 0 6px;
    max-width: 120px;
  }
  .tab-bar button.active {
    background: linear-gradient(145deg, #d6d6f0, #a1a1f7);
    color: white;
    box-shadow:
      inset 5px 5px 8px #6b6bcd,
      inset -5px -5px 8px #b1b1ff;
    transform: translateY(-3px);
  }
  .tab-bar button:hover:not(.active) {
    box-shadow:
      5px 5px 8px #bfbfbf,
      -5px -5px 8px #f7f7f7;
  }

  /* Content container */
  #content > section {
    display: none;
    padding: 0 12px 30px;
    max-width: 600px;
    margin: auto;
  }
  #content > section.active {
    display: block;
  }

  /* Instagram style posts */
  .insta-post {
    background: white;
    border-radius: 16px;
    box-shadow: 0 3px 10px rgb(0 0 0 / 0.1);
    margin-bottom: 1.5rem;
    overflow: hidden;
  }
  .insta-post img {
    width: 100%;
    display: block;
    object-fit: cover;
  }
  .insta-caption {
    padding: 12px 16px;
    font-weight: 600;
    font-size: 1rem;
    color: #111;
  }
  .insta-views {
    padding: 0 16px 12px;
    color: #999;
    font-size: 0.875rem;
  }

  /* Community item */
  .community-item {
    background: white;
    border-radius: 14px;
    padding: 12px 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
  }
  .community-item h3 {
    margin: 0 0 6px 0;
    font-weight: 700;
  }
  .community-item p {
    margin: 0;
    color: #444;
  }

  /* Following list */
  .follow-list {
    max-width: 600px;
    margin: auto;
  }
  .follow-item {
    display: flex;
    align-items: center;
    background: white;
    border-radius: 14px;
    padding: 10px 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
  }
  .follow-item img {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 14px;
  }
  .follow-info {
    flex-grow: 1;
  }
  .follow-info .username {
    font-weight: 700;
    font-size: 1.1rem;
    color: #111;
  }
  .follow-info .handle {
    font-size: 0.9rem;
    color: #777;
  }
  .unfollow-btn {
    background: #ff3b30;
    border: none;
    color: white;
    padding: 6px 14px;
    border-radius: 14px;
    cursor: pointer;
    font-weight: 700;
    transition: background 0.3s ease;
  }
  .unfollow-btn:hover {
    background: #e32b20;
  }

  /* Loading text style */
  .loading {
    text-align: center;
    padding: 40px 0;
    font-weight: 600;
    color: #666;
  }
</style>
</head>
<body>

<!-- Top tab buttons -->
<div class="tab-bar">
  <button id="tab-home" class="active">Home</button>
  <button id="tab-community">Community</button>
  <button id="tab-following">Following</button>
</div>

<!-- Content Sections -->
<div id="content">
  <section id="home" class="active"></section>
  <section id="community"></section>
  <section id="following"></section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getDatabase, ref, get, child, onValue, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  // UI Elements
  const tabHomeBtn = document.getElementById('tab-home');
  const tabCommunityBtn = document.getElementById('tab-community');
  const tabFollowingBtn = document.getElementById('tab-following');

  const homePage = document.getElementById('home');
  const communityPage = document.getElementById('community');
  const followingPage = document.getElementById('following');

  // Current user uid (set after auth)
  let currentUserUid = null;

  // Sanitizer to prevent injection
  function sanitize(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Tab switching handler
  function setActiveTab(tab) {
    // Buttons active states
    tabHomeBtn.classList.toggle('active', tab === 'home');
    tabCommunityBtn.classList.toggle('active', tab === 'community');
    tabFollowingBtn.classList.toggle('active', tab === 'following');
    // Sections visible states
    homePage.classList.toggle('active', tab === 'home');
    communityPage.classList.toggle('active', tab === 'community');
    followingPage.classList.toggle('active', tab === 'following');

    // Load content as needed
    if(tab === 'home') loadHomePosts();
    else if(tab === 'community') loadCommunityItems();
    else if(tab === 'following') loadFollowing();
  }

  // Load Home posts - Instagram style
  async function loadHomePosts() {
    homePage.innerHTML = '<p class="loading">Loading posts...</p>';
    try {
      const snapshot = await get(ref(db, 'post'));
      if (!snapshot.exists()) {
        homePage.innerHTML = '<p class="loading">No posts yet.</p>';
        return;
      }
      const posts = snapshot.val();
      let html = '';
      for (const id in posts) {
        const post = posts[id];
        const title = sanitize(post.title || '');
        const imageUrl = post.imageUrl || '';
        const views = post.views || 0;
        html += `
          <div class="insta-post">
            ${imageUrl ? `<img src="${imageUrl}" alt="${title}">` : ''}
            <div class="insta-caption">${title}</div>
            <div class="insta-views">${views} views</div>
          </div>`;
      }
      homePage.innerHTML = html;
    } catch (e) {
      console.error(e);
      homePage.innerHTML = '<p class="loading">Error loading posts.</p>';
    }
  }

  // Load Community polls + quizzes combined
  async function loadCommunityItems() {
    communityPage.innerHTML = '<p class="loading">Loading community content...</p>';
    try {
      const [pollsSnap, quizSnap] = await Promise.all([
        get(ref(db, 'polls')),
        get(ref(db, 'quiz'))
      ]);
      let html = '';
      if (pollsSnap.exists()) {
        const polls = pollsSnap.val();
        for (const id in polls) {
          const poll = polls[id];
          html += `
            <div class="community-item">
              <h3>Poll: ${sanitize(poll.question || 'Untitled')}</h3>
              <p>${sanitize(poll.description || '')}</p>
            </div>`;
        }
      }
      if (quizSnap.exists()) {
        const quizzes = quizSnap.val();
        for (const id in quizzes) {
          const quiz = quizzes[id];
          html += `
            <div class="community-item">
              <h3>Quiz: ${sanitize(quiz.title || 'Untitled')}</h3>
              <p>${sanitize(quiz.description || '')}</p>
            </div>`;
        }
      }
      communityPage.innerHTML = html || '<p class="loading">No community content found.</p>';
    } catch (e) {
      console.error(e);
      communityPage.innerHTML = '<p class="loading">Error loading community content.</p>';
    }
  }

  // Load Following users list
  async function loadFollowing() {
    followingPage.innerHTML = '<p class="loading">Loading following list...</p>';
    if (!currentUserUid) {
      followingPage.innerHTML = '<p class="loading">Please log in to see your following list.</p>';
      return;
    }
    try {
      // Get the list of following UIDs
      const followingsSnap = await get(ref(db, `following/${currentUserUid}`));
      if (!followingsSnap.exists()) {
        followingPage.innerHTML = '<p class="loading">You are not following anyone.</p>';
        return;
      }
      const followings = followingsSnap.val();
      let html = '<div class="follow-list">';
      // For each UID in following, get their profile
      const userPromises = Object.keys(followings).map(async (uid) => {
        const userSnap = await get(ref(db, `users/${uid}`));
        if (!userSnap.exists()) return '';
        const user = userSnap.val();
        const profilePic = user.profilePic || 'https://via.placeholder.com/48?text=User';
        const username = sanitize(user.username || 'Unknown');
        const handle = sanitize(user.handle || '@unknown');
        // Return a follow item block with unfollow button
        return `
          <div class="follow-item" data-uid="${uid}">
            <img src="${profilePic}" alt="${username}">
            <div class="follow-info">
              <div class="username">${username}</div>
              <div class="handle">${handle}</div>
            </div>
            <button class="unfollow-btn">Unfollow</button>
          </div>`;
      });
      const userHtmlArr = await Promise.all(userPromises);
      html += userHtmlArr.join('');
      html += '</div>';
      followingPage.innerHTML = html;

      // Add click handlers to unfollow buttons
      const unfollowButtons = followingPage.querySelectorAll('.unfollow-btn');
      unfollowButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
          const parent = btn.closest('.follow-item');
          const uidToUnfollow = parent.getAttribute('data-uid');
          if (!uidToUnfollow) return;
          // Remove from following list in DB
          try {
            await update(ref(db, `following/${currentUserUid}/${uidToUnfollow}`), null);
            // Optimistically remove from UI
            parent.remove();
          } catch (e) {
            alert('Failed to unfollow user. Try again.');
            console.error(e);
          }
        });
      });

    } catch (e) {
      console.error(e);
      followingPage.innerHTML = '<p class="loading">Error loading following list.</p>';
    }
  }

  // Listen for auth state changes
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUserUid = user.uid;
    } else {
      currentUserUid = null;
    }
    // Reload current tab content
    const activeTab = document.querySelector('.tab-bar button.active').id.replace('tab-', '');
    setActiveTab(activeTab);
  });

  // Tab buttons click handlers
  tabHomeBtn.addEventListener('click', () => setActiveTab('home'));
  tabCommunityBtn.addEventListener('click', () => setActiveTab('community'));
  tabFollowingBtn.addEventListener('click', () => setActiveTab('following'));

  // Initial load
  setActiveTab('home');
</script>

</body>
</html>