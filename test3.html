<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CyberChat Upload</title>
<style>
  /* Minimal styling for progress UI */
  #progressOverlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex; justify-content: center; align-items: center;
    z-index: 10000; color: #0f0; font-family: monospace;
    font-size: 1.4rem; display: none;
  }
  #progressOverlay.visible {
    display: flex;
  }
  #progressMessage {
    background: #222; padding: 2rem 3rem; border-radius: 12px;
  }
  .tag {
    display: inline-block; background: #444; padding: 0 8px; margin: 0 5px 5px 0; border-radius: 12px; color: #0f0;
  }
</style>
  <style>  
    * {  
      margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif;  
    }  
    body {  
      background: #121212; color: #eee; padding-bottom: 80px;  
    }  
    header {  
      background: #1f1f1f;  
      padding: 15px 20px;  
      display: flex;  
      justify-content: space-between;  
      align-items: center;  
      border-bottom: 1px solid #333;  
      position: sticky;  
      top: 0;  
      z-index: 100;  
    }  
    header h1 {  
      font-size: 20px;  
      font-weight: bold;  
    }  
    header img {  
      width: 32px; height: 32px; border-radius: 50%;  
    }  
  
    .container {  
      max-width: 600px;  
      margin: 20px auto;  
      padding: 0 15px;  
    }  
  
    .drop-zone {  
      border: 2px dashed #444;  
      padding: 40px;  
      text-align: center;  
      border-radius: 10px;  
      background: #1e1e1e;  
      cursor: pointer;  
    }  
  
    .hidden { display: none; }  
  
    .section {  
      margin-top: 30px;  
    }  
  
    label {  
      display: block;  
      margin: 12px 0 6px;  
    }  
  
    input[type="text"], textarea, select {  
      width: 100%;  
      padding: 10px;  
      background: #2a2a2a;  
      border: 1px solid #333;  
      color: white;  
      border-radius: 6px;  
    }  
  
    .tag-input {  
      display: flex;  
      flex-wrap: wrap;  
      background: #2a2a2a;  
      padding: 8px;  
      border-radius: 6px;  
      border: 1px solid #333;  
    }  
  
    .tag {  
      background: #333;  
      color: #ccc;  
      padding: 5px 10px;  
      margin: 3px;  
      border-radius: 5px;  
      font-size: 14px;  
    }  
  
    .toggle {  
      display: flex;  
      align-items: center;  
      margin-top: 10px;  
    }  
  
    .toggle input {  
      margin-right: 10px;  
      width: 18px;  
      height: 18px;  
    }  
  
    .footer {  
      position: fixed;  
      bottom: 0;  
      left: 0;  
      width: 100%;  
      background: #1f1f1f;  
      padding: 15px;  
      border-top: 1px solid #333;  
    }  
  
    .footer button {  
      width: 100%;  
      padding: 14px;  
      background: #00c67c;  
      border: none;  
      border-radius: 8px;  
      font-size: 16px;  
      color: white;  
      font-weight: bold;  
      cursor: pointer;  
    }  
  
    .meta-box {  
      border: 1px solid #333;  
      padding: 15px;  
      border-radius: 8px;  
      background: #1a1a1a;  
      margin-top: 20px;  
    }  
  
    .meta-box h3 {  
      font-size: 16px;  
      margin-bottom: 10px;  
      color: #aaa;  
    }  
  
    .cpm-display {  
      margin-top: 10px;  
      color: #ccc;  
      font-style: italic;  
      display: inline-block;  
    }  
  
    .cpm-info-container {  
      position: relative;  
      display: inline-block;  
    }  
  
    #infoIcon {  
      cursor: pointer;   
      color: #00c67c;   
      margin-left: 8px;   
      font-weight: bold;  
      user-select: none;  
      border: 1px solid #00c67c;  
      border-radius: 50%;  
      width: 20px;  
      height: 20px;  
      text-align: center;  
      line-height: 18px;  
      font-size: 14px;  
      display: inline-block;  
    }  
  
    #cpmPopup {  
      position: absolute;   
      top: 24px;   
      left: 0;   
      background: #222;   
      color: #ccc;   
      padding: 10px;   
      border: 1px solid #333;   
      border-radius: 6px;   
      width: 280px;   
      z-index: 999;  
      font-size: 14px;  
      line-height: 1.3;  
    }  
  </style>  
</head>
<body>
<header>
  <h1>CyberChat</h1>
  <img id="profileImg" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ4Cz4QyUZAetgiOhayGT846gGiS3gO-tH4Iu0EOaOnBahRhPqOmgaKy7c&s=10" alt="Profile" width="32" height="32" />
</header>

<div class="container">
  <div class="drop-zone" id="dropZone" style="border: 2px dashed #444; padding: 20px; cursor:pointer; margin-bottom:1rem;">
    Drop up to 2 images here or click to upload
  </div>

  <div id="postDetails" class="section hidden" style="display:none;">
    <h2>Post Details</h2>

    <label>Title * (max 50 chars)</label><br />
    <input type="text" required id="title" maxlength="50" style="width: 100%;" /><br /><br />

    <label>Description *</label><br />
    <textarea rows="4" required id="description" style="width: 100%;"></textarea><br /><br />

    <label>Tags * (space or enter to add)</label><br />
    <div class="tag-input" id="tagInput" style="background: #222; padding: 5px; color: white; display: flex; flex-wrap: wrap; gap: 5px; border-radius: 5px;">
      <input type="text" id="tagField" style="background: transparent; border: none; color: white; outline: none; flex: 1 0 100px;" />
    </div><br />

    <div class="meta-box" style="background: #111; padding: 10px; border-radius: 8px;">
      <h3>Monetization & Links</h3>

      <label>Visibility</label><br />
      <select id="visibility">
        <option value="public">Public</option>
        <option value="followers">Followers Only</option>
      </select><br /><br />

      <label>Allow Comments</label><br />
      <select id="comments">
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </select><br /><br />

      <label>External Link</label><br />
      <input type="text" placeholder="https://example.com" id="externalLink" style="width: 100%;" /><br /><br />

      <div class="toggle">
        <input type="checkbox" id="monetize" />
        <label for="monetize">Monetize this post to earn money</label>
      </div><br />

      <div class="cpm-info-container" style="position: relative; display: inline-block;">
        <span id="cpmEstimate">Estimated CPM: Low CPM</span>
        <span id="infoIcon" style="cursor:pointer; background:#666; color:#fff; border-radius:50%; width:18px; height:18px; text-align:center; line-height:18px; display:inline-block; margin-left: 6px;">?</span>
        <div id="cpmPopup" style="display:none; position: absolute; top: 22px; left: 0; background:#222; padding: 10px; border-radius: 8px; width: 250px; font-size: 0.9rem; z-index: 10; color: #ccc;">
          <strong>CPM info:</strong><br><br>
          CPM is based on your postâ€™s engagement and content. <br>
          <ul style="padding-left: 1.2em;">
            <li><strong>Low</strong>: Max $1 CPM</li>
            <li><strong>Moderate</strong>: Max $2.50 CPM</li>
            <li><strong>High</strong>: Max $4 CPM</li>
          </ul>
          Keep your title & description engaging with trending topics and multiple images for better CPM.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="footer" style="margin-top: 1rem;">
  <button id="uploadBtn" style="padding: 10px 20px; font-size: 1rem;">Upload Now</button>
</div>

<div id="progressOverlay">
  <div id="progressMessage">Uploading...</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const realtimeDB = getDatabase(app);

  // Elements
  const profileImg = document.getElementById('profileImg');
  const dropZone = document.getElementById('dropZone');
  const postDetails = document.getElementById('postDetails');
  const title = document.getElementById('title');
  const description = document.getElementById('description');
  const tagField = document.getElementById('tagField');
  const tagInput = document.getElementById('tagInput');
  const monetizeCheckbox = document.getElementById('monetize');
  const cpmEstimate = document.getElementById('cpmEstimate');
  const infoIcon = document.getElementById('infoIcon');
  const cpmPopup = document.getElementById('cpmPopup');
  const uploadBtn = document.getElementById('uploadBtn');
  const progressOverlay = document.getElementById('progressOverlay');
  const progressMessage = document.getElementById('progressMessage');

  const fallbackImageUrl = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ4Cz4QyUZAetgiOhayGT846gGiS3gO-tH4Iu0EOaOnBahRhPqOmgaKy7c&s=10";

  // Profile image load or fallback
  onAuthStateChanged(auth, user => {
    profileImg.src = user?.photoURL || fallbackImageUrl;
  });
  profileImg.onerror = () => { profileImg.src = fallbackImageUrl; };

  // Image selection max 2
  let selectedImages = [];
  dropZone.addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.multiple = true;
    input.onchange = () => handleFiles(input.files);
    input.click();
  });
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = '#00c67c'; });
  dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = '#444'; });
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.style.borderColor = '#444';
    handleFiles(e.dataTransfer.files);
  });

  function handleFiles(files) {
    const imgs = Array.from(files).filter(f => f.type.startsWith('image/'));
    if (imgs.length > 2) {
      alert('Only 2 images allowed');
      return;
    }
    selectedImages = imgs;
    postDetails.style.display = 'block';
    dropZone.innerHTML = imgs.map(f => `<div>${f.name}</div>`).join('');
    calcCPM();
  }

  // Tags management (unique, trimmed, lowercase)
  let tags = [];
  tagField.addEventListener('keydown', e => {
    if (e.key === ' ' || e.key === 'Enter') {
      e.preventDefault();
      const val = tagField.value.trim().toLowerCase();
      if (val && !tags.includes(val)) {
        tags.push(val);
        const span = document.createElement('span');
        span.className = 'tag';
        span.textContent = '#' + val;
        tagInput.insertBefore(span, tagField);
        tagField.value = '';
        calcCPM();
      }
    }
  });

  // CPM logic
  const getPostTier = (titleText, descText, tagList) => {
    const highEngagementTags = ['gta6', 'ai', 'fortnite', 'tech', 'money', 'bitcoin', 'crypto', 'stock'];
    const text = (titleText + ' ' + descText).toLowerCase();
    let score = 0;

    if (highEngagementTags.some(t => text.includes(t))) score += 30;
    if (tagList.length >= 3) score += 20;
    if (descText.length > 100) score += 20;
    if (titleText.length > 20) score += 10;
    if (selectedImages.length === 2) score += 20;

    let tier = 'Low';
    if (score >= 70) tier = 'High';
    else if (score >= 40) tier = 'Moderate';

    return { tier, score: Math.min(score, 100) };
  };

  const calculateCPM = (tier, score) => {
    const tierCaps = { Low: 1.0, Moderate: 2.5, High: 4.0 };
    const maxCPM = tierCaps[tier];
    const cpm = ((score / 100) * maxCPM).toFixed(2);
    return parseFloat(cpm);
  };

  function calcCPM() {
    const titleVal = title.value || '';
    const descVal = description.value || '';
    const { tier, score } = getPostTier(titleVal, descVal, tags);
    const estimated = calculateCPM(tier, score);
    cpmEstimate.textContent = `Estimated CPM: $${estimated} (${tier})`;
  }

  title.addEventListener('input', calcCPM);
  description.addEventListener('input', calcCPM);

  infoIcon.addEventListener('click', () => {
    cpmPopup.style.display = cpmPopup.style.display === 'block' ? 'none' : 'block';
  });
  document.addEventListener('click', e => {
    if (!infoIcon.contains(e.target) && !cpmPopup.contains(e.target)) {
      cpmPopup.style.display = 'none';
    }
  });

  function validateForm() {
    if (selectedImages.length === 0 || selectedImages.length > 2) {
      alert('Please upload 1 or 2 images.');
      return false;
    }

    const titleVal = title.value.trim();
    const descVal = description.value.trim();

    if (!titleVal) {
      alert('Title is required.');
      return false;
    }
    if (titleVal.length > 100) {
      alert('Title is too long. Keep it under 100 characters.');
      return false;
    }

    if (!descVal) {
      alert('Description is required.');
      return false;
    }
    if (descVal.length > 1000) {
      alert('Description is too long. Max 1000 characters allowed.');
      return false;
    }

    return true;
  }

  async function uploadToImgur(file) {
    const formData = new FormData();
    formData.append('image', file);

    const res = await fetch('https://api.imgur.com/3/image', {
      method: 'POST',
      headers: { Authorization: 'Client-ID 891e5bb4aa94282' },
      body: formData,
    });

    const data = await res.json();
    if (data.success) {
      return data.data.link;
    } else {
      throw new Error('Imgur upload failed: ' + (data.data?.error || 'unknown error'));
    }
  }

  uploadBtn.addEventListener('click', async () => {
    if (!validateForm()) return;
    if (!auth.currentUser) {
      alert('You must be logged in to upload.');
      return;
    }

    try {
      progressOverlay.classList.add('visible');
      progressMessage.textContent = 'Uploading images... 0%';

      const uploadedUrls = [];
      for (let i = 0; i < selectedImages.length; i++) {
        const img = selectedImages[i];
        progressMessage.textContent = `Uploading images... ${Math.round(((i + 1) / selectedImages.length) * 100)}%`;
        const url = await uploadToImgur(img);
        uploadedUrls.push(url);
      }

      progressMessage.textContent = 'Fetching monetize status...';
      const monetizeStatus = await getUserMonetizeStatus(auth.currentUser.uid);

      progressMessage.textContent = 'Saving post data...';

      const postObj = {
        uid: auth.currentUser.uid,
        authorName: auth.currentUser.displayName || 'Anonymous',
        authorPhoto: auth.currentUser.photoURL || fallbackImageUrl,
        title: title.value.trim(),
        description: description.value.trim(),
        tags,
        images: uploadedUrls,
        monetize: monetizeCheckbox.checked && monetizeStatus === 'on',
        cpmEstimate: cpmEstimate.textContent,
        createdAt: serverTimestamp(),
      };

      const postsCollection = collection(db, 'post');
      await addDoc(postsCollection, postObj);

      progressMessage.textContent = 'Post uploaded successfully!';

      // Reset UI
      selectedImages = [];
      dropZone.innerHTML = 'Click or drag images here (max 2)';
      postDetails.style.display = 'none';
      title.value = '';
      description.value = '';
      tagInput.querySelectorAll('.tag').forEach(tag => tag.remove());
      tags = [];
      monetizeCheckbox.checked = false;
      calcCPM();

      setTimeout(() => {
        progressOverlay.classList.remove('visible');
        progressMessage.textContent = '';
      }, 2000);
    } catch (error) {
      progressOverlay.classList.remove('visible');
      alert('Error uploading post: ' + error.message);
    }
  });

  async function getUserMonetizeStatus(uid) {
    try {
      const snap = await get(ref(realtimeDB, `users/${uid}/monetize`));
      return snap.exists() ? snap.val() : 'off';
    } catch (error) {
      console.error('Failed to fetch monetize status:', error);
      return 'off';
    }
  }
</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
import { getDatabase, ref, get, child, push, set } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.appspot.com",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
  measurementId: "G-LLT6F9WRKH"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);
const provider = new GoogleAuthProvider();

const loginModal = document.getElementById('loginModal');
const loginBtn = document.getElementById('loginBtn');
const profilePic = document.getElementById('profilePic');
const userHandle = document.getElementById('userHandle');
const userFollowers = document.getElementById('userFollowers');
const previewImage = document.getElementById('previewImage');
const imgurUrlContainer = document.getElementById('imgurUrlContainer');
const postBtn = document.getElementById('postBtn');

function showLogin() {
  loginModal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}
function hideLogin() {
  loginModal.classList.add('hidden');
  document.body.style.overflow = 'auto';
}

loginBtn.addEventListener('click', () => {
  signInWithPopup(auth, provider)
    .catch((error) => alert("Login failed: " + error.message));
});

onAuthStateChanged(auth, async (user) => {
  if (user) {
    hideLogin();
    const uid = user.uid;

    profilePic.src = user.photoURL || 'https://via.placeholder.com/40';
    userHandle.textContent = '@' + (user.displayName?.replace(/\s+/g, '').toLowerCase() || 'user');

    try {
      const dbRef = ref(database);
      const snapshot = await get(child(dbRef, `users/${uid}/followers`));
      userFollowers.textContent = snapshot.exists()
        ? `Followers: ${snapshot.val()}`
        : 'Followers: 0';
    } catch (error) {
      userFollowers.textContent = 'Followers: --';
    }
  } else {
    showLogin();
    profilePic.src = 'https://via.placeholder.com/40';
    userHandle.textContent = '@guest';
    userFollowers.textContent = 'Followers: --';
  }
});

// Load image from sessionStorage and disable manual upload
document.addEventListener('DOMContentLoaded', () => {
  const imageData = sessionStorage.getItem('uploadedImage');
  if (imageData && previewImage) {
    previewImage.src = imageData;
    previewImage.style.objectFit = 'cover';
  } else {
    alert("No image found. Redirecting...");
    window.history.back();
  }
});

postBtn.addEventListener('click', async () => {
  const titleInput = document.getElementById('titleInput');
  const captionInput = document.getElementById('captionInput');
  const tagsInput = document.getElementById('tagsInput');
  const categorySelect = document.getElementById('categorySelect');

  if (!titleInput.value.trim()) return alert('Title is required');
  if (!captionInput.value.trim()) return alert('Caption is required');
  if (!tagsInput.value.trim()) return alert('Tags are required');
  if (!categorySelect.value) return alert('Please select a category');

  const user = auth.currentUser;
  if (!user) return alert('You must be logged in to post.');

  const imageData = previewImage.src;
  if (!imageData || imageData.startsWith('data:image/gif;base64,R0lGODlh')) {
    return alert('Please upload a valid image.');
  }

  try {
    // Step 1: Push skeleton post WITHOUT imageUrl (placeholder)
    const postsRef = ref(database, 'posts');
    const newPostRef = push(postsRef);
    const postData = {
      userId: user.uid,
      userName: user.displayName || user.email || 'Anonymous',
      userPhoto: user.photoURL || '',
      title: titleInput.value.trim(),
      caption: captionInput.value.trim(),
      tags: tagsInput.value.trim().split(',').map(t => t.trim()).filter(Boolean),
      category: categorySelect.value,
      imageUrl: null, // Placeholder, to be updated after upload
      createdAt: Date.now(),
    };
    await set(newPostRef, postData);

    // Step 2: Upload image to Imgur
    const imgurRes = await fetch('https://api.imgur.com/3/image', {
      method: 'POST',
      headers: {
        Authorization: 'Client-ID 784e530b6023501',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ image: imageData.split(',')[1], type: 'base64' }),
    });

    const imgurJson = await imgurRes.json();
    if (!imgurJson.success) throw new Error('Imgur upload failed');

    const imgurLink = imgurJson.data.link;

    // Step 3: Update post with real image URL
    await set(ref(database, `posts/${newPostRef.key}/imageUrl`), imgurLink);

    // Show Imgur URL below form
    imgurUrlContainer.innerHTML = `<p class="text-green-400 mt-2">Imgur URL: <a href="${imgurLink}" target="_blank" class="underline">${imgurLink}</a></p>`;

    alert('Post published successfully!');

    // Reset form and preview
    titleInput.value = '';
    captionInput.value = '';
    tagsInput.value = '';
    categorySelect.value = '';
    previewImage.src = 'https://via.placeholder.com/1280x720.png?text=Preview+Image';
    imgurUrlContainer.innerHTML = '';

  } catch (error) {
    console.error('Post error:', error);
    alert('Failed to publish post: ' + error.message);
  }
});
</script>
</body>
</html>