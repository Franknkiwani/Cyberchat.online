<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Real Creator Dashboard</title>
<style>
  /* Same styles as before, omitted for brevity */
  /* ... Use your previous styles here ... */
  body {
    background: #121212; color: #eee; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }
  /* Add your CSS from before */
</style>
</head>
<body>

<header>
  <div id="hamburger">&#9776;</div>
  <h1 style="font-weight:700; font-size:1.2rem; color:#4caf50; margin:0;">Creator Dashboard</h1>
</header>

<aside id="sidebar">
  <nav>
    <a href="#">Dashboard</a>
    <a href="#">Monetize</a>
    <a href="#">Posts</a>
    <a href="#">Profile</a>
    <a href="#" id="logout-btn">Logout</a>
  </nav>
</aside>

<main>
  <section class="profile-overview">
    <img id="user-photo" src="https://via.placeholder.com/64" alt="User Photo" />
    <div class="profile-info">
      <h2 id="username">Loading...</h2>
      <p id="userhandle">@loading</p>
      <p><strong>Followers:</strong> <span id="followers-count">0</span></p>
    </div>
  </section>

  <section class="stats-grid">
    <div class="stat-box">
      <div class="stat-title">Total Views</div>
      <div class="stat-value" id="total-views">0</div>
      <div class="stat-change positive" id="views-change">+0 today</div>
      <div class="progress-bar-container">
        <div id="views-progress" class="progress-bar"></div>
      </div>
    </div>
    <div class="stat-box">
      <div class="stat-title">Total Earnings</div>
      <div class="stat-value" id="total-earnings">$0.00</div>
      <div class="stat-change positive" id="earnings-change">+ $0.00 today</div>
      <div class="progress-bar-container">
        <div id="earnings-progress" class="progress-bar"></div>
      </div>
    </div>
    <div class="stat-box">
      <div class="stat-title">Total Posts</div>
      <div class="stat-value" id="total-posts">0</div>
      <div class="stat-change positive" id="posts-change">+0 today</div>
    </div>
    <div class="stat-box monetization-box">
      <div class="stat-title">Monetization Status</div>
      <div class="monetization-status" id="monetize-status">Checking...</div>
      <button id="monetize-btn" disabled>Toggle Monetization</button>
    </div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    onValue,
    get,
    update,
    child,
    query,
    orderByChild,
  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // Elements
  const usernameEl = document.getElementById("username");
  const userhandleEl = document.getElementById("userhandle");
  const userPhotoEl = document.getElementById("user-photo");
  const followersCountEl = document.getElementById("followers-count");

  const totalViewsEl = document.getElementById("total-views");
  const viewsChangeEl = document.getElementById("views-change");
  const viewsProgressEl = document.getElementById("views-progress");

  const totalEarningsEl = document.getElementById("total-earnings");
  const earningsChangeEl = document.getElementById("earnings-change");
  const earningsProgressEl = document.getElementById("earnings-progress");

  const totalPostsEl = document.getElementById("total-posts");
  const postsChangeEl = document.getElementById("posts-change");

  const monetizeStatusEl = document.getElementById("monetize-status");
  const monetizeBtn = document.getElementById("monetize-btn");

  let currentUserId;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // Redirect or show login
      alert("Not logged in!");
      return;
    }
    currentUserId = user.uid;
    loadUserProfile(currentUserId);
    loadStatsRealtime(currentUserId);
    setupMonetizationToggle(currentUserId);
  });

  function loadUserProfile(uid) {
    const userRef = ref(db, `users/${uid}`);
    onValue(userRef, (snapshot) => {
      if (!snapshot.exists()) return;
      const user = snapshot.val();
      usernameEl.textContent = user.username || "No Username";
      userhandleEl.textContent = user.handle ? `@${user.handle}` : `@${user.username || 'user'}`;
      userPhotoEl.src = user.photoURL || "https://via.placeholder.com/64";
    });

    // Followers count (assuming followers stored as keys)
    const followersRef = ref(db, `followers/${uid}`);
    onValue(followersRef, (snap) => {
      const followersObj = snap.val();
      const count = followersObj ? Object.keys(followersObj).length : 0;
      followersCountEl.textContent = count;
    });
  }

  function loadStatsRealtime(uid) {
    // Total posts by user
    const postsRef = ref(db, "posts");
    onValue(postsRef, (snapshot) => {
      const posts = snapshot.val() || {};
      let totalPosts = 0, totalViews = 0, totalEarnings = 0;

      const today = new Date();
      const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const todayStartTs = todayStart.getTime();

      let viewsToday = 0, earningsToday = 0, postsToday = 0;

      for (const postId in posts) {
        const post = posts[postId];
        if (post.authorId !== uid) continue;
        totalPosts++;
        totalViews += post.views || 0;
        totalEarnings += post.earnings || 0;

        // Assuming post.createdAt is a timestamp in ms
        if (post.createdAt >= todayStartTs) {
          postsToday++;
          viewsToday += post.viewsToday || 0; // if you track daily views separately
          earningsToday += post.earningsToday || 0; // likewise daily earnings
        }
      }

      totalPostsEl.textContent = totalPosts;
      totalViewsEl.textContent = totalViews;
      totalEarningsEl.textContent = `$${totalEarnings.toFixed(2)}`;

      postsChangeEl.textContent = `+${postsToday} today`;
      viewsChangeEl.textContent = `+${viewsToday} today`;
      earningsChangeEl.textContent = `+ $${earningsToday.toFixed(2)} today`;

      // Progress bars: simple example showing progress to some arbitrary goals
      viewsProgressEl.style.width = Math.min(100, (totalViews / 10000) * 100) + "%";
      earningsProgressEl.style.width = Math.min(100, (totalEarnings / 500) * 100) + "%";
    });
  }

  function setupMonetizationToggle(uid) {
    const monetizeRef = ref(db, `users/${uid}/monetize`);
    onValue(monetizeRef, (snapshot) => {
      const status = snapshot.val();
      monetizeStatusEl.textContent = status ? "Monetized" : "Not Monetized";
      monetizeBtn.disabled = false;
      monetizeBtn.textContent = status ? "Disable Monetization" : "Enable Monetization";
    });

    monetizeBtn.onclick = () => {
      monetizeBtn.disabled = true; // prevent spam
      get(ref(db, `users/${uid}/monetize`)).then((snap) => {
        const current = snap.val();
        update(ref(db, `users/${uid}`), {
          monetize: !current,
        }).then(() => {
          monetizeBtn.disabled = false;
        });
      });
    };
  }

  // Logout
  document.getElementById("logout-btn").addEventListener("click", () => {
    signOut(auth);
  });
</script>

</body>
</html>