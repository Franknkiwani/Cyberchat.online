<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apply for Monetization</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      margin: 0;
      background: #0d1117;
      color: #fff;
    }

    h1 {
      text-align: center;
      color: #58a6ff;
    }

    .form-container {
      max-width: 500px;
      margin: 0 auto;
      background: #161b22;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(88, 166, 255, 0.2);
    }

    label {
      display: block;
      margin-top: 15px;
    }

    input[type="text"],
    input[type="file"],
    input[type="email"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin-top: 5px;
      background: #0d1117;
      color: white;
    }

    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      background: #238636;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    button:disabled {
      background: #3b3f44;
      cursor: not-allowed;
    }

    .stats-box {
      margin-top: 20px;
      background: #21262d;
      padding: 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>Apply for Monetization</h1>
  <div class="form-container">
    <div id="userStats" class="stats-box">
      <p><strong>Followers:</strong> <span id="followerCount">Loading...</span></p>
      <p><strong>Post Views:</strong> <span id="totalViews">Loading...</span></p>
    </div>

    <form id="monetizationForm">
      <label for="name">First Name *</label>
      <input type="text" id="name" required>

      <label for="surname">Last Name *</label>
      <input type="text" id="surname" required>

      <label for="address">Address *</label>
      <input type="text" id="address" required>

      <label for="email">Email *</label>
      <input type="email" id="email" required>

      <label for="photo">Upload a Photo *</label>
      <input type="file" id="photo" accept="image/*" required>

      <button type="submit" id="applyButton" disabled>Apply Now</button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.filestorage.app",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const applyBtn = document.getElementById("applyButton");
    const followerCountSpan = document.getElementById("followerCount");
    const viewCountSpan = document.getElementById("totalViews");

    let currentUser;

    onAuthStateChanged(auth, async user => {
      if (!user) return window.location.href = "accounts.html";

      currentUser = user;
      const uid = user.uid;

      const [postsSnap, followersSnap, userSnap] = await Promise.all([
        get(ref(db, "/post")),
        get(ref(db, `/followers/${uid}`)),
        get(ref(db, `/users/${uid}`))
      ]);

      const posts = postsSnap.val() || {};
      const followers = followersSnap.exists() ? Object.keys(followersSnap.val()).length : 0;

      let views = 0;
      for (const key in posts) {
        const post = posts[key];
        if (post.uid === uid && post.monetized === true) {
          views += post.views || 0;
        }
      }

      viewCountSpan.textContent = views;
      followerCountSpan.textContent = followers;

      if (views >= 1000 && followers >= 100) {
        applyBtn.disabled = false;
        document.getElementById("email").value = user.email;
      }
    });

    document.getElementById("monetizationForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      applyBtn.textContent = "Applying...";

      const name = document.getElementById("name").value.trim();
      const surname = document.getElementById("surname").value.trim();
      const address = document.getElementById("address").value.trim();
      const email = document.getElementById("email").value.trim();
      const file = document.getElementById("photo").files[0];

      if (!file) return alert("Photo is required.");

      // Upload to Imgur
      const formData = new FormData();
      formData.append("image", file);

      const imgurRes = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
          Authorization: "Client-ID 891e5bb4aa94282"
        },
        body: formData
      });

      const imgurData = await imgurRes.json();
      if (!imgurData.success) return alert("Imgur upload failed.");

      const imageUrl = imgurData.data.link;

      // Save application
      const applicationData = {
        uid: currentUser.uid,
        name,
        surname,
        address,
        email,
        imageUrl,
        timestamp: Date.now()
      };

      await set(ref(db, `/applications/${currentUser.uid}`), applicationData);
      await update(ref(db, `/users/${currentUser.uid}`), {
        monetize: "pending"
      });

      alert("Application submitted! Status: Pending");
      window.location.href = "/dashboard.html"; // or wherever you want
    });
  </script>
</body>
</html>