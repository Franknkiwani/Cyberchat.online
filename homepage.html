<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Make Money - Dark Theme</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: #121212;
      color: #eee;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      display: flex;
      justify-content: center;
      padding: 0 20px;
    }

    .header-wrapper {
      width: 100%;
      max-width: 460px;
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      background: #181818;
      padding: 10px 0 12px;
      z-index: 9999;
      box-sizing: border-box;
      border-bottom: 1px solid #2a2a2a;
      user-select: none;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 28px;
      background: #222;
      border-radius: 40px;
      border: 1px solid #333;
      user-select: none;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .logo {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, #4ade80, #22c55e);
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 700;
      font-size: 26px;
      color: white;
      user-select: none;
    }
    .site-name {
      font-weight: 700;
      font-size: 18px;
      color: #eee;
      user-select: none;
    }

    .balance-btn {
      background: #22c55e;
      color: white;
      font-weight: 600;
      font-size: 16px;
      padding: 10px 30px;
      border-radius: 9999px;
      border: 2px solid black;
      cursor: pointer;
      transition: background 0.25s ease;
      user-select: none;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }
    .balance-btn:focus {
      outline: none;
    }

    .main {
      margin-top: 90px; /* moved sections closer to header */
      max-width: 460px;
      width: 100%;
      user-select: none;
    }

    .sections {
      display: flex;
      justify-content: space-between;
      padding: 0 12px;
      margin-bottom: 16px;
      border-bottom: 1px solid #333;
      user-select: none;
      flex-direction: row; /* always row, no stacking */
    }

    .section {
      position: relative;
      width: 48%;
      background: transparent;
      padding: 14px 0;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      font-weight: 600;
      color: #aaa;
      box-shadow: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: color 0.3s ease, border-color 0.3s ease;
      justify-content: center;
      user-select: none;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }
    .section:hover {
      color: #22c55e;
    }

    .section.active,
    .section:focus {
      color: #22c55e;
      border-bottom-color: #22c55e;
      font-weight: 700;
      outline: none !important;
    }

    .section:focus {
      outline: none !important;
    }

    /* Icons container size */
    .section-icon {
      width: 26px;
      height: 26px;
      flex-shrink: 0;
      stroke-width: 2.2;
    }
    .section-icon svg {
      width: 100%;
      height: 100%;
      stroke: currentColor;
      fill: none;
      stroke-linejoin: round;
      stroke-linecap: round;
    }

    /* Special fill for Make Money icon */
    .make-money-icon svg {
      fill: currentColor;
      stroke: none;
    }

    main {
      padding: 0 12px;
      color: #ccc;
      min-height: 160px;
      user-select: text; /* Allow text selection inside content */
    }

    main h1 {
      color: #eee;
      user-select: text;
    }

    main p {
      user-select: text;
    }

    /* Keep header and sections nice on mobile but no stacking */
    @media (max-width: 480px) {
      .sections {
        flex-direction: row; /* keep side by side on mobile */
        gap: 12px;
        padding: 0 8px;
      }
      .section {
        width: 48%;
        justify-content: center;
        padding-left: 0;
      }
      header {
        padding: 14px 20px;
      }
      .header-wrapper {
        padding: 8px 0 10px;
      }
    }
    #cashout-form input {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  background: #1f1f1f;
  border: 1px solid #333;
  color: #eee;
  font-size: 14px;
  margin-bottom: 8px;
}
#cashout-form label {
  font-weight: 600;
  display: block;
  margin-bottom: 6px;
  color: #ccc;
}
#cashout-form small {
  color: #888;
  font-size: 13px;
}
.required {
  color: #f87171;
}

.submit-btn {
  margin-top: 12px;
  padding: 12px;
  background: #22c55e;
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  font-size: 16px;
  width: 100%;
  cursor: pointer;
  transition: background 0.2s ease;
}
.submit-btn:hover {
  background: #16a34a;
}
  </style>
</head>
<body>
  <div class="header-wrapper">
    <header>
      <div class="logo-container">
        <div class="logo">$</div>
        <div class="site-name">Earnify</div>
      </div>
      <button class="balance-btn" tabindex="0">$0.00</button>
    </header>
  </div>

  <div class="main">
    <div class="sections" role="tablist" aria-label="Main navigation tabs">
      <div class="section active" data-tab="make-money" tabindex="0" role="tab" aria-selected="true" aria-controls="make-money-content" id="make-money-tab">
        <span class="section-icon make-money-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" >
            <rect x="3" y="3" width="18" height="18" rx="6" ry="6"/>
            <text x="12" y="17" text-anchor="middle" font-size="14" font-weight="700" fill="#121212" font-family="Arial, sans-serif">$</text>
          </svg>
        </span>
        <span>Make Money</span>
      </div>
      <div class="section" data-tab="cashout" tabindex="0" role="tab" aria-selected="false" aria-controls="cashout-content" id="cashout-tab">
        <span class="section-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" >
            <path d="M7 7l5-5m0 0l5 5m-5-5v18" />
            <path d="M17 17l-5 5m0 0l-5-5m5 5V3" />
          </svg>
        </span>
        <span>Cashout</span>
      </div>
    </div>

    <main>
      <section id="make-money-content" role="tabpanel" aria-labelledby="make-money-tab">
        <h1>Make Money</h1>
        <p>Complete tasks and earn real cash. Get started with offers and promotions to boost your earnings quickly.</p>
      </section>
      <section id="cashout-content" role="tabpanel" aria-labelledby="cashout-tab" hidden>
       <h1>Cashout</h1>
<p></p>

<label for="provider-select" style="display:block; margin-top:1em;">Choose payment method:</label>
<select id="provider-select" style="width:100%; padding:10px; margin-top:6px; border-radius:8px; border:none; background:#1e1e1e; color:#eee;">
  <option value="">-- Select Provider --</option>
  <option value="paypal">PayPal</option>
  <option value="bank">Bank Transfer</option>
  <option value="payoneer">Payoneer</option>
  <option value="amazon">Amazon Gift Card</option>
  <option value="bitcoin">Bitcoin</option>
  <option value="usdd">USDD</option>
</select>

<div id="cashout-form" style="margin-top: 20px;"></div>
</section>
    </main>
  </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
  import { getDatabase, ref, onValue, push, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const balanceBtn = document.querySelector('.balance-btn');
  const providerSelect = document.getElementById('provider-select');
  const formContainer = document.getElementById('cashout-form');

  let currentUser = null;
  let userBalanceRef = null;

  // Show balance or login prompt
  function updateBalanceUI(balance) {
    balanceBtn.textContent = `$${(balance || 0).toFixed(2)}`;
  }

  function resetUIForLogout() {
    updateBalanceUI(0);
    formContainer.innerHTML = '';
    providerSelect.value = '';
  }

  // Listen for auth state changes
  onAuthStateChanged(auth, user => {
    currentUser = user;
    if (user) {
      // Setup balance reference
      userBalanceRef = ref(db, `users/${user.uid}/balance`);
      // Listen for balance updates
      onValue(userBalanceRef, snapshot => {
        const balance = snapshot.val();
        updateBalanceUI(balance);
      });
    } else {
      resetUIForLogout();
    }
  });

  // Tab navigation code unchanged
  const tabs = document.querySelectorAll('.section');
  const contents = document.querySelectorAll('main > section');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      activateTab(tab.dataset.tab);
    });
    tab.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        activateTab(tab.dataset.tab);
      }
    });
  });

  function activateTab(tabName) {
    tabs.forEach(t => {
      const selected = t.dataset.tab === tabName;
      t.classList.toggle('active', selected);
      t.setAttribute('aria-selected', selected);
      if (selected) t.focus();
    });
    contents.forEach(c => {
      c.hidden = c.id !== tabName + '-content';
    });
  }

  // Cashout form templates (unchanged)
  const formTemplates = {
    paypal: {
      min: 10,
      max: 100,
      html: `
        <label>Withdraw Amount <span class="required">*</span>:</label>
        <input type="number" id="amount" placeholder="e.g. 25" required />

        <label>Email <span class="required">*</span>:</label>
        <input type="email" id="email" required />

        <label>Confirm Email <span class="required">*</span>:</label>
        <input type="email" id="confirmEmail" required />
      `
    },
    bank: {
      min: 15,
      max: 500,
      html: `
        <label>Withdraw Amount <span class="required">*</span>:</label>
        <input type="number" id="amount" required />

        <label>First Name <span class="required">*</span>:</label>
        <input type="text" id="fname" required />

        <label>Last Name <span class="required">*</span>:</label>
        <input type="text" id="lname" required />

        <label>Email <span class="required">*</span>:</label>
        <input type="email" id="email" required />

        <label>Account Number <span class="required">*</span>:</label>
        <input type="text" id="account" required />

        <label>Bank Name <span class="required">*</span>:</label>
        <input type="text" id="bank" required />

        <label>Country <span class="required">*</span>:</label>
        <input type="text" id="country" required />

        <label>Phone Number <span class="required">*</span>:</label>
        <input type="tel" id="phone" required />
      `
    },
    payoneer: {
      min: 20,
      max: 250,
      html: `
        <label>Withdraw Amount <span class="required">*</span>:</label>
        <input type="number" id="amount" required />

        <label>Payoneer Email <span class="required">*</span>:</label>
        <input type="email" id="email" required />
      `
    },
    amazon: {
      min: 5,
      max: 100,
      html: `
        <label>Withdraw Amount <span class="required">*</span>:</label>
        <input type="number" id="amount" required />

        <label>Email for Gift Card <span class="required">*</span>:</label>
        <input type="email" id="email" required />
      `
    },
    bitcoin: {
      min: 20,
      max: 300,
      html: `
        <label>Withdraw Amount <span class="required">*</span>:</label>
        <input type="number" id="amount" required />

        <label>Bitcoin Wallet Address <span class="required">*</span>:</label>
        <input type="text" id="wallet" required />
      `
    },
    usdd: {
      min: 20,
      max: 300,
      html: `
        <label>Withdraw Amount <span class="required">*</span>:</label>
        <input type="number" id="amount" required />

        <label>TRC20 Wallet Address <span class="required">*</span>:</label>
        <input type="text" id="wallet" required />
      `
    }
  };

  providerSelect.addEventListener('change', () => {
    const selected = providerSelect.value;
    if (!selected) {
      formContainer.innerHTML = '';
      return;
    }

    const { html } = formTemplates[selected];
    formContainer.innerHTML = `
      <form id="cashoutRequestForm">
        ${html}
        <button type="submit" class="submit-btn">Confirm Cashout</button>
        <small id="form-error" style="color:#f87171; display:none; margin-top:8px;"></small>
      </form>
    `;
  });

  formContainer.addEventListener('submit', async function (e) {
    if (!e.target.matches('#cashoutRequestForm')) return;

    e.preventDefault();

    if (!currentUser) {
      alert("Please log in to request a cashout.");
      return;
    }

    const selected = providerSelect.value;
    const form = e.target;
    const fields = form.querySelectorAll('input[required]');
    const errorMsg = form.querySelector('#form-error');
    const amountInput = form.querySelector('#amount');
    const amount = parseFloat(amountInput?.value);
    const { min, max } = formTemplates[selected];

    // Validation
    let allFilled = true;
    fields.forEach(f => {
      if (!f.value.trim()) {
        allFilled = false;
      }
    });

    if (!allFilled) {
      errorMsg.textContent = 'Please fill in all required fields.';
      errorMsg.style.display = 'block';
      return;
    }

    if (isNaN(amount) || amount < min || amount > max) {
      errorMsg.textContent = `Amount must be between $${min} and $${max}.`;
      errorMsg.style.display = 'block';
      return;
    }

    // For PayPal, confirm email match
    if (selected === 'paypal') {
      const email = form.querySelector('#email').value.trim();
      const confirmEmail = form.querySelector('#confirmEmail').value.trim();
      if (email.toLowerCase() !== confirmEmail.toLowerCase()) {
        errorMsg.textContent = "Email and Confirm Email do not match.";
        errorMsg.style.display = 'block';
        return;
      }
    }

    errorMsg.style.display = 'none';

    try {
      // Transactionally check and deduct balance
      const userBalanceRef = ref(db, `users/${currentUser.uid}/balance`);
      const cashoutRequestsRef = ref(db, `cashoutRequests`);

      // Use a transaction to prevent race conditions and cheating
      const transactionResult = await runTransaction(userBalanceRef, (currentBalance) => {
        if (currentBalance === null || currentBalance < amount) {
          return; // Abort transaction - insufficient balance
        }
        return currentBalance - amount;
      });

      if (!transactionResult.committed) {
        errorMsg.textContent = "Insufficient balance for this cashout.";
        errorMsg.style.display = 'block';
        return;
      }

      // Save cashout request record
      const cashoutData = {
        uid: currentUser.uid,
        provider: selected,
        amount: amount,
        details: {},
        status: 'pending',
        createdAt: serverTimestamp()
      };

      // Collect details except amount
      fields.forEach(f => {
        if (f.id !== 'amount') {
          cashoutData.details[f.id] = f.value.trim();
        }
      });

      await push(cashoutRequestsRef, cashoutData);

      alert('Cashout request submitted successfully!');
      form.reset();
      providerSelect.value = '';
      formContainer.innerHTML = '';

    } catch (error) {
      console.error(error);
      errorMsg.textContent = "An error occurred while submitting your cashout request.";
      errorMsg.style.display = 'block';
    }
  });
</script>
</body>
</html>